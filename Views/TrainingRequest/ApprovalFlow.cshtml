@model TrainingRequestApp.Models.TrainingRequestEditViewModel
@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Approval Workflow Timeline";

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸´à¸—à¸˜à¸´à¹Œ User
    var userRole = Context.Session.GetString("UserRole") ?? "User";
    bool isAdmin = userRole.Contains("Admin", StringComparison.OrdinalIgnoreCase) ||
                   userRole.Contains("System Admin", StringComparison.OrdinalIgnoreCase);

    // Skip approver constant
    const string SKIP_APPROVER = "à¸œà¸¹à¹‰à¸šà¸±à¸‡à¸„à¸±à¸šà¸šà¸±à¸à¸Šà¸²à¸¥à¸³à¸”à¸±à¸šà¸–à¸±à¸”à¹„à¸› à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´";

    // Helper function to check if approver is skipped
    bool IsSkipApprover(string approverId)
    {
        return string.Equals(approverId?.Trim(), SKIP_APPROVER, StringComparison.OrdinalIgnoreCase);
    }

    // Helper functions
    string GetStatusClass(string levelStatus, string mainStatus, string waitingStatus)
    {
        // à¹ƒà¸Šà¹‰ Case-Insensitive Comparison à¹€à¸à¸·à¹ˆà¸­à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡ "Approved" à¹à¸¥à¸° "APPROVED"
        if (string.Equals(levelStatus, "Approved", StringComparison.OrdinalIgnoreCase))
            return "approved";
        // à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡ "Reject", "REJECTED", à¹à¸¥à¸° "Revise"
        if (string.Equals(levelStatus, "Reject", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(levelStatus, "Rejected", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(levelStatus, "Revise", StringComparison.OrdinalIgnoreCase))
            return "rejected";
        if (mainStatus == waitingStatus)
            return "waiting";
        return "pending";
    }

    string GetStatusDisplay(string levelStatus, string mainStatus, string waitingStatus)
    {
        // à¹ƒà¸Šà¹‰ Case-Insensitive Comparison à¹€à¸à¸·à¹ˆà¸­à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡ "Approved" à¹à¸¥à¸° "APPROVED"
        if (string.Equals(levelStatus, "Approved", StringComparison.OrdinalIgnoreCase))
            return "Approved";
        // à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡ "Reject" à¹à¸¥à¸° "REJECTED"
        if (string.Equals(levelStatus, "Reject", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(levelStatus, "Rejected", StringComparison.OrdinalIgnoreCase))
            return "Rejected";
        if (string.Equals(levelStatus, "Revise", StringComparison.OrdinalIgnoreCase))
            return "Revise";
        if (mainStatus == waitingStatus)
            return "Waiting";
        return "Pending";
    }
}

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>

    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


<style>
    .timeline-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
    }

    .doc-info-card {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .doc-info-card h3 {
        margin-top: 0;
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }

    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 50px;
        top: 0;
        bottom: 0;
        width: 4px;
        background: #e0e0e0;
    }

    .timeline-item {
        position: relative;
        padding: 20px 0 20px 120px;
        min-height: 100px;
    }

    .timeline-marker {
        position: absolute;
        left: 35px;
        top: 25px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 4px solid #e0e0e0;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        z-index: 10;
    }

    .timeline-marker.pending {
        border-color: #f39c12;
        color: #f39c12;
    }

    .timeline-marker.approved {
        border-color: #27ae60;
        background: #27ae60;
        color: #fff;
    }

    .timeline-marker.rejected {
        border-color: #e74c3c;
        background: #e74c3c;
        color: #fff;
    }

    .timeline-marker.waiting {
        border-color: #3498db;
        background: #3498db;
        color: #fff;
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .timeline-content {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #e0e0e0;
    }

    .timeline-content.pending {
        border-left-color: #f39c12;
    }

    .timeline-content.approved {
        border-left-color: #27ae60;
    }

    .timeline-content.rejected {
        border-left-color: #e74c3c;
    }

    .timeline-content.waiting {
        border-left-color: #3498db;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .timeline-title {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
    }

    .status-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-badge.pending {
        background: #f39c12;
        color: #fff;
    }

    .status-badge.approved {
        background: #27ae60;
        color: #fff;
    }

    .status-badge.rejected {
        background: #e74c3c;
        color: #fff;
    }

    .status-badge.waiting {
        background: #3498db;
        color: #fff;
    }

    .approver-info {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }

    .approver-email {
        color: #3498db;
        font-weight: 500;
    }

    .approval-date {
        color: #7f8c8d;
        font-size: 14px;
        margin-top: 5px;
    }

    .comment-box {
        margin-top: 10px;
        padding: 10px;
        background: #fff3cd;
        border-left: 3px solid #ffc107;
        border-radius: 3px;
    }

    .comment-label {
        font-weight: bold;
        color: #856404;
    }

    .send-email-btn {
        background: #27ae60;
        color: #fff;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin: 20px 0;
    }

    .send-email-btn:hover {
        background: #229954;
    }

    .back-btn {
        background: #95a5a6;
        color: #fff;
        border: none;
        padding: 10px 25px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
    }

    .back-btn:hover {
        background: #7f8c8d;
    }
</style>
</head>
<body>

<div class="timeline-container">
    <!-- Document Info Card -->
    <div class="doc-info-card">
        <h3>ğŸ“„ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸³à¸‚à¸­à¸­à¸šà¸£à¸¡</h3>
        <div class="row">
            <div class="col-md-6">
                <p><strong>à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹€à¸­à¸à¸ªà¸²à¸£:</strong> @Model.DocNo</p>
                <p><strong>à¸šà¸£à¸´à¸©à¸±à¸—:</strong> @Model.Company</p>
                <p><strong>à¸«à¸±à¸§à¸‚à¹‰à¸­à¸­à¸šà¸£à¸¡:</strong> @Model.SeminarTitle</p>
            </div>
            <div class="col-md-6">
                <p><strong>à¸§à¸±à¸™à¸—à¸µà¹ˆà¸­à¸šà¸£à¸¡:</strong> @Model.StartDate?.ToString("dd/MM/yyyy") - @Model.EndDate?.ToString("dd/MM/yyyy")</p>
                <p><strong>à¸ªà¸–à¸²à¸™à¸°à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:</strong> <span class="badge badge-info">@Model.Status</span></p>
                <p><strong>à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡:</strong> @Model.CreatedBy</p>
            </div>
        </div>

        @if (string.Equals(Model.Status, "Pending", StringComparison.OrdinalIgnoreCase))
        {
            <button id="sendEmailBtn" class="send-email-btn">
                ğŸ“§ à¸ªà¹ˆà¸‡ Email à¹€à¸£à¸´à¹ˆà¸¡à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´
            </button>
        }
        else
        {
            <button onclick="window.location.href='/TrainingRequest/Edit?docNo=@Model.DocNo'" class="send-email-btn" style="background: #3498db;">
                ğŸ“ à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹à¸¥à¸°à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´
            </button>
        }

        @* à¸›à¸¸à¹ˆà¸¡ Retry Email - à¸ªà¸³à¸«à¸£à¸±à¸š Admin/System Admin à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ *@
        @* à¹à¸ªà¸”à¸‡à¹ƒà¸™à¸—à¸¸à¸à¸ªà¸–à¸²à¸™à¸° à¸¢à¸à¹€à¸§à¹‰à¸™ REJECTED (à¹€à¸à¸£à¸²à¸°à¹€à¸­à¸à¸ªà¸²à¸£à¸–à¸¹à¸à¸›à¸à¸´à¹€à¸ªà¸˜à¹à¸¥à¹‰à¸§ à¹„à¸¡à¹ˆà¸¡à¸µà¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´) *@
        @if (isAdmin &&
             !string.Equals(Model.Status, "REJECTED", StringComparison.OrdinalIgnoreCase))
        {
            <button id="btnRetryEmail" class="send-email-btn" style="background: #17a2b8; margin-left: 10px;">
                ğŸ”„ Retry Email
            </button>
        }

        <button onclick="window.location.href='/Home/MonthlyRequests'" class="back-btn">
            â† à¸à¸¥à¸±à¸š
        </button>
    </div>

    <!-- Timeline -->
    <div class="timeline">
        <!-- Level 1: Section Manager -->
        @{
            var sectionStatus = Model.Status_SectionManager ?? "Pending";
            var sectionClass = GetStatusClass(sectionStatus, Model.Status, "WAITING_FOR_SECTION_MANAGER");
        }
        <div class="timeline-item">
            <div class="timeline-marker @sectionClass">1</div>
            <div class="timeline-content @sectionClass">
                <div class="timeline-header">
                    <div class="timeline-title">ğŸ”¹ Section Manager</div>
                    <span class="status-badge @sectionClass">@GetStatusDisplay(sectionStatus, Model.Status, "WAITING_FOR_SECTION_MANAGER")</span>
                </div>
                <div class="approver-info">
                    <div class="approver-email">
                        @if (IsSkipApprover(Model.SectionManagerId))
                        {
                            <span class="text-warning">â­ï¸ à¸‚à¹‰à¸²à¸¡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸™à¸µà¹‰ (Skip)</span>
                        }
                        else if (!string.IsNullOrEmpty(Model.SectionManagerId))
                        {
                            <span>ğŸ“§ @Model.SectionManagerId</span>
                        }
                        else
                        {
                            <span class="text-muted">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</span>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ApproveInfo_SectionManager))
                    {
                        <div class="approval-date">âœ… @Model.ApproveInfo_SectionManager</div>
                    }
                </div>
                @if (!string.IsNullOrEmpty(Model.Comment_SectionManager))
                {
                    <div class="comment-box">
                        <div class="comment-label">ğŸ’¬ à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹€à¸«à¹‡à¸™:</div>
                        <div>@Model.Comment_SectionManager</div>
                    </div>
                }
            </div>
        </div>

        <!-- Level 2: Department Manager -->
        @{
            var deptStatus = Model.Status_DepartmentManager ?? "Pending";
            var deptClass = GetStatusClass(deptStatus, Model.Status, "WAITING_FOR_DEPARTMENT_MANAGER");
        }
        <div class="timeline-item">
            <div class="timeline-marker @deptClass">2</div>
            <div class="timeline-content @deptClass">
                <div class="timeline-header">
                    <div class="timeline-title">ğŸ”¹ Department Manager</div>
                    <span class="status-badge @deptClass">@GetStatusDisplay(deptStatus, Model.Status, "WAITING_FOR_DEPARTMENT_MANAGER")</span>
                </div>
                <div class="approver-info">
                    <div class="approver-email">
                        @if (IsSkipApprover(Model.DepartmentManagerId))
                        {
                            <span class="text-warning">â­ï¸ à¸‚à¹‰à¸²à¸¡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸™à¸µà¹‰ (Skip)</span>
                        }
                        else if (!string.IsNullOrEmpty(Model.DepartmentManagerId))
                        {
                            <span>ğŸ“§ @Model.DepartmentManagerId</span>
                        }
                        else
                        {
                            <span class="text-muted">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</span>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ApproveInfo_DepartmentManager))
                    {
                        <div class="approval-date">âœ… @Model.ApproveInfo_DepartmentManager</div>
                    }
                </div>
                @if (!string.IsNullOrEmpty(Model.Comment_DepartmentManager))
                {
                    <div class="comment-box">
                        <div class="comment-label">ğŸ’¬ à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹€à¸«à¹‡à¸™:</div>
                        <div>@Model.Comment_DepartmentManager</div>
                    </div>
                }
            </div>
        </div>

        <!-- Level 3: HRD Admin -->
        @{
            var hrdAdminStatus = Model.Status_HRDAdmin ?? "Pending";
            var hrdAdminClass = GetStatusClass(hrdAdminStatus, Model.Status, "WAITING_FOR_HRD_ADMIN");
        }
        <div class="timeline-item">
            <div class="timeline-marker @hrdAdminClass">3</div>
            <div class="timeline-content @hrdAdminClass">
                <div class="timeline-header">
                    <div class="timeline-title">ğŸ”¹ HRD Admin</div>
                    <span class="status-badge @hrdAdminClass">@GetStatusDisplay(hrdAdminStatus, Model.Status, "WAITING_FOR_HRD_ADMIN")</span>
                </div>
                <div class="approver-info">
                    <div class="approver-email">
                        @if (!string.IsNullOrEmpty(Model.HRDAdminId))
                        {
                            <span>ğŸ“§ @Model.HRDAdminId</span>
                        }
                        else
                        {
                            <span class="text-muted">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</span>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ApproveInfo_HRDAdmin))
                    {
                        <div class="approval-date">âœ… @Model.ApproveInfo_HRDAdmin</div>
                    }
                </div>
                @if (!string.IsNullOrEmpty(Model.Comment_HRDAdmin))
                {
                    <div class="comment-box">
                        <div class="comment-label">ğŸ’¬ à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹€à¸«à¹‡à¸™:</div>
                        <div>@Model.Comment_HRDAdmin</div>
                    </div>
                }
            </div>
        </div>

        <!-- Level 4: HRD Confirmation -->
        @{
            var hrdConfirmStatus = Model.Status_HRDConfirmation ?? "Pending";
            var hrdConfirmClass = GetStatusClass(hrdConfirmStatus, Model.Status, "WAITING_FOR_HRD_CONFIRMATION");
        }
        <div class="timeline-item">
            <div class="timeline-marker @hrdConfirmClass">4</div>
            <div class="timeline-content @hrdConfirmClass">
                <div class="timeline-header">
                    <div class="timeline-title">ğŸ”¹ HRD Confirmation</div>
                    <span class="status-badge @hrdConfirmClass">@GetStatusDisplay(hrdConfirmStatus, Model.Status, "WAITING_FOR_HRD_CONFIRMATION")</span>
                </div>
                <div class="approver-info">
                    <div class="approver-email">
                        @if (!string.IsNullOrEmpty(Model.HRDConfirmationId))
                        {
                            <span>ğŸ“§ @Model.HRDConfirmationId</span>
                        }
                        else
                        {
                            <span class="text-muted">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</span>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ApproveInfo_HRDConfirmation))
                    {
                        <div class="approval-date">âœ… @Model.ApproveInfo_HRDConfirmation</div>
                    }
                </div>
                @if (!string.IsNullOrEmpty(Model.Comment_HRDConfirmation))
                {
                    <div class="comment-box">
                        <div class="comment-label">ğŸ’¬ à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹€à¸«à¹‡à¸™:</div>
                        <div>@Model.Comment_HRDConfirmation</div>
                    </div>
                }
            </div>
        </div>

        <!-- Level 5: Director -->
        @{
            var mdStatus = Model.Status_ManagingDirector ?? "Pending";
            var mdClass = GetStatusClass(mdStatus, Model.Status, "WAITING_FOR_MANAGING_DIRECTOR");
        }
        <div class="timeline-item">
            <div class="timeline-marker @mdClass">5</div>
            <div class="timeline-content @mdClass">
                <div class="timeline-header">
                    <div class="timeline-title">ğŸ”¹ Director</div>
                    <span class="status-badge @mdClass">@GetStatusDisplay(mdStatus, Model.Status, "WAITING_FOR_MANAGING_DIRECTOR")</span>
                </div>
                <div class="approver-info">
                    <div class="approver-email">
                        @if (IsSkipApprover(Model.ManagingDirectorId))
                        {
                            <span class="text-warning">â­ï¸ à¸‚à¹‰à¸²à¸¡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸™à¸µà¹‰ (Skip)</span>
                        }
                        else if (!string.IsNullOrEmpty(Model.ManagingDirectorId))
                        {
                            <span>ğŸ“§ @Model.ManagingDirectorId</span>
                        }
                        else
                        {
                            <span class="text-muted">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</span>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ApproveInfo_ManagingDirector))
                    {
                        <div class="approval-date">âœ… @Model.ApproveInfo_ManagingDirector</div>
                    }
                </div>
                @if (!string.IsNullOrEmpty(Model.Comment_ManagingDirector))
                {
                    <div class="comment-box">
                        <div class="comment-label">ğŸ’¬ à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹€à¸«à¹‡à¸™:</div>
                        <div>@Model.Comment_ManagingDirector</div>
                    </div>
                }
            </div>
        </div>

        <!-- Level 6: Deputy Managing Director -->
        @{
            var dmdStatus = Model.Status_DeputyManagingDirector ?? "Pending";
            var dmdClass = GetStatusClass(dmdStatus, Model.Status, "WAITING_FOR_DEPUTY_MANAGING_DIRECTOR");
        }
        <div class="timeline-item">
            <div class="timeline-marker @dmdClass">6</div>
            <div class="timeline-content @dmdClass">
                <div class="timeline-header">
                    <div class="timeline-title">ğŸ”¹ Deputy Managing Director</div>
                    <span class="status-badge @dmdClass">@GetStatusDisplay(dmdStatus, Model.Status, "WAITING_FOR_DEPUTY_MANAGING_DIRECTOR")</span>
                </div>
                <div class="approver-info">
                    <div class="approver-email">
                        @if (IsSkipApprover(Model.DeputyManagingDirectorId))
                        {
                            <span class="text-warning">â­ï¸ à¸‚à¹‰à¸²à¸¡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸™à¸µà¹‰ (Skip)</span>
                        }
                        else if (!string.IsNullOrEmpty(Model.DeputyManagingDirectorId))
                        {
                            <span>ğŸ“§ @Model.DeputyManagingDirectorId</span>
                        }
                        else
                        {
                            <span class="text-muted">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</span>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ApproveInfo_DeputyManagingDirector))
                    {
                        <div class="approval-date">âœ… @Model.ApproveInfo_DeputyManagingDirector</div>
                    }
                </div>
                @if (!string.IsNullOrEmpty(Model.Comment_DeputyManagingDirector))
                {
                    <div class="comment-box">
                        <div class="comment-label">ğŸ’¬ à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹€à¸«à¹‡à¸™:</div>
                        <div>@Model.Comment_DeputyManagingDirector</div>
                    </div>
                }
            </div>
        </div>

        <!-- Final Status -->
        @if (string.Equals(Model.Status, "APPROVED", StringComparison.OrdinalIgnoreCase))
        {
            <div class="timeline-item">
                <div class="timeline-marker approved">âœ“</div>
                <div class="timeline-content approved">
                    <div class="timeline-header">
                        <div class="timeline-title">ğŸ‰ à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§</div>
                        <span class="status-badge approved">APPROVED</span>
                    </div>
                    <p>à¸„à¸³à¸‚à¸­à¸­à¸šà¸£à¸¡à¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸„à¸£à¸šà¸—à¸¸à¸à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¹à¸¥à¹‰à¸§</p>
                </div>
            </div>
        }
        else if (string.Equals(Model.Status, "Revise", StringComparison.OrdinalIgnoreCase))
        {
            <div class="timeline-item">
                <div class="timeline-marker rejected">!</div>
                <div class="timeline-content rejected">
                    <div class="timeline-header">
                        <div class="timeline-title">ğŸ”„ à¸ªà¹ˆà¸‡à¸à¸¥à¸±à¸šà¹à¸à¹‰à¹„à¸‚</div>
                        <span class="status-badge rejected">REVISE</span>
                    </div>
                    <p>à¸à¸£à¸¸à¸“à¸²à¹à¸à¹‰à¹„à¸‚à¹€à¸­à¸à¸ªà¸²à¸£à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¹€à¸«à¹‡à¸™à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</p>
                </div>
            </div>
        }
        else if (string.Equals(Model.Status, "Revision Admin", StringComparison.OrdinalIgnoreCase))
        {
            <div class="timeline-item">
                <div class="timeline-marker rejected">!</div>
                <div class="timeline-content rejected">
                    <div class="timeline-header">
                        <div class="timeline-title">ğŸ”„ à¸ªà¹ˆà¸‡à¸à¸¥à¸±à¸šà¹ƒà¸«à¹‰ HRD Admin à¹à¸à¹‰à¹„à¸‚</div>
                        <span class="status-badge rejected">REVISION ADMIN</span>
                    </div>
                    <p>HRD Admin à¸à¸£à¸¸à¸“à¸²à¹à¸à¹‰à¹„à¸‚à¹€à¸­à¸à¸ªà¸²à¸£à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸•à¹ˆà¸­</p>
                </div>
            </div>
        }
        else if (string.Equals(Model.Status, "Reject", StringComparison.OrdinalIgnoreCase) ||
                 string.Equals(Model.Status, "REJECTED", StringComparison.OrdinalIgnoreCase))
        {
            <div class="timeline-item">
                <div class="timeline-marker rejected">âœ—</div>
                <div class="timeline-content rejected">
                    <div class="timeline-header">
                        <div class="timeline-title">âŒ à¹„à¸¡à¹ˆà¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</div>
                        <span class="status-badge rejected">REJECTED</span>
                    </div>
                    <p>à¸„à¸³à¸‚à¸­à¸­à¸šà¸£à¸¡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</p>
                </div>
            </div>
        }
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    console.log('%câ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'color: #4CAF50; font-weight: bold;');
    console.log('%câ•‘  Training Request Approval Workflow - Debug Console     â•‘', 'color: #4CAF50; font-weight: bold;');
    console.log('%câ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #4CAF50; font-weight: bold;');
    console.log('ğŸ“‹ Document Number:', '@Model.DocNo');
    console.log('ğŸ“Š Current Status:', '@Model.Status');
    console.log('ğŸ‘¤ Created By:', '@Model.CreatedBy');
    console.log('ğŸ“§ CC Email:', '@Model.CCEmail');
    console.log('\nğŸ“Œ TIP: Open this console (F12) before clicking "Send Email" to see detailed debug information\n');

    $('#sendEmailBtn').click(function() {
        console.log('\n%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #2196F3; font-weight: bold;');
        console.log('%cğŸš€ Send Approval Email Button Clicked', 'color: #2196F3; font-weight: bold; font-size: 14px;');
        console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #2196F3; font-weight: bold;');
        console.log('â° Timestamp:', new Date().toLocaleString('th-TH'));
        console.log('ğŸ“„ DocNo:', '@Model.DocNo');

        if (!confirm('à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸ªà¹ˆà¸‡ Email à¹€à¸£à¸´à¹ˆà¸¡à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹ƒà¸Šà¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?')) {
            console.log('âŒ User cancelled the operation');
            return;
        }

        console.log('âœ… User confirmed - Disabling button and sending AJAX request...');
        $(this).prop('disabled', true).text('à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡...');

        console.log('ğŸ“¡ AJAX Request Details:');
        console.log('   URL: /TrainingRequest/SendApprovalEmail');
        console.log('   Method: POST');
        console.log('   Data:', { docNo: '@Model.DocNo' });

        $.ajax({
            url: '/TrainingRequest/SendApprovalEmail',
            type: 'POST',
            data: { docNo: '@Model.DocNo' },
            success: function(response) {
                console.log('\n%câœ… AJAX SUCCESS Response Received', 'color: #4CAF50; font-weight: bold; font-size: 14px;');
                console.log('Response Object:', response);
                console.log('   success:', response.success);
                console.log('   message:', response.message);
                if (response.debugInfo) {
                    console.log('   debugInfo:', response.debugInfo);
                }
                if (response.errorType) {
                    console.log('   errorType:', response.errorType);
                }

                if (response.success) {
                    console.log('%câœ… Workflow started successfully!', 'color: #4CAF50; font-weight: bold;');
                    console.log('ğŸ”„ Redirecting to Edit page...');
                    alert(response.message + '\n\nâœ… à¸£à¸°à¸šà¸šà¸ˆà¸°à¸™à¸³à¸„à¸¸à¸“à¹„à¸›à¸¢à¸±à¸‡à¸«à¸™à¹‰à¸²à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´');
                    window.location.href = '/TrainingRequest/Edit?docNo=' + '@Model.DocNo';
                } else {
                    console.error('%câŒ Workflow failed!', 'color: #f44336; font-weight: bold;');
                    console.error('Error Message:', response.message);
                    console.error('Debug Info:', response.debugInfo);
                    console.log('%cğŸ’¡ Check the SERVER CONSOLE for detailed error logs', 'color: #FF9800; font-weight: bold; font-size: 12px;');
                    alert(response.message + '\n\nğŸ’¡ à¹€à¸›à¸´à¸” Server Console à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹ error details');
                    $('#sendEmailBtn').prop('disabled', false).text('ğŸ“§ à¸ªà¹ˆà¸‡ Email à¹€à¸£à¸´à¹ˆà¸¡à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´');
                }
            },
            error: function(xhr, status, error) {
                console.log('\n%câŒ AJAX ERROR', 'color: #f44336; font-weight: bold; font-size: 14px;');
                console.error('XHR Object:', xhr);
                console.error('Status:', status);
                console.error('Error:', error);
                console.error('Response Text:', xhr.responseText);
                console.error('Status Code:', xhr.status);
                console.log('%cğŸ’¡ This is a network/HTTP error, not a workflow error', 'color: #FF9800; font-weight: bold;');

                alert('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡ Email\n\nStatus: ' + status + '\nError: ' + error + '\n\nğŸ’¡ à¹€à¸›à¸´à¸” Browser Console (F12) à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹ details');
                $('#sendEmailBtn').prop('disabled', false).text('ğŸ“§ à¸ªà¹ˆà¸‡ Email à¹€à¸£à¸´à¹ˆà¸¡à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´');
            }
        });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”„ Retry Email Button Handler (à¸ªà¸³à¸«à¸£à¸±à¸š Admin/System Admin)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    $('#btnRetryEmail').click(function() {
        console.log('\n%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #17a2b8; font-weight: bold;');
        console.log('%cğŸ”„ Retry Email Button Clicked', 'color: #17a2b8; font-weight: bold; font-size: 14px;');
        console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #17a2b8; font-weight: bold;');
        console.log('â° Timestamp:', new Date().toLocaleString('th-TH'));
        console.log('ğŸ“„ DocNo:', '@Model.DocNo');
        console.log('ğŸ“Š Current Status:', '@Model.Status');

        const confirmMsg = 'à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡ Email à¸‹à¹‰à¸³?\n\n' +
                          'Email à¸ˆà¸°à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¹„à¸›à¸¢à¸±à¸‡:\n' +
                          'â€¢ à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸„à¸™à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™\n' +
                          'â€¢ à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸­à¸à¸ªà¸²à¸£ (CreatedBy)\n' +
                          'â€¢ CC Emails\n' +
                          'â€¢ HRD Admin\n\n' +
                          'à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸•à¹ˆà¸­à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?';

        if (!confirm(confirmMsg)) {
            console.log('âŒ User cancelled the operation');
            return;
        }

        console.log('âœ… User confirmed - Disabling button and sending AJAX request...');
        const $btn = $(this);
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡ Email...');

        console.log('ğŸ“¡ AJAX Request Details:');
        console.log('   URL: /TrainingRequest/RetryEmail');
        console.log('   Method: POST');
        console.log('   Data:', { docNo: '@Model.DocNo' });

        $.ajax({
            url: '/TrainingRequest/RetryEmail',
            type: 'POST',
            data: { docNo: '@Model.DocNo' },
            success: function(response) {
                console.log('\n%câœ… AJAX SUCCESS Response Received', 'color: #4CAF50; font-weight: bold; font-size: 14px;');
                console.log('Response Object:', response);
                console.log('   success:', response.success);
                console.log('   message:', response.message);

                if (response.success) {
                    console.log('%câœ… Retry Email sent successfully!', 'color: #4CAF50; font-weight: bold;');
                    alert('âœ… ' + response.message + '\n\nEmail à¹„à¸”à¹‰à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¹„à¸›à¸¢à¸±à¸‡à¸œà¸¹à¹‰à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹à¸¥à¸°à¸œà¸¹à¹‰à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¹à¸¥à¹‰à¸§');
                    $btn.prop('disabled', false).html(originalText);
                } else {
                    console.error('%câŒ Retry Email failed!', 'color: #f44336; font-weight: bold;');
                    console.error('Error Message:', response.message);
                    alert('âŒ ' + response.message);
                    $btn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr, status, error) {
                console.log('\n%câŒ AJAX ERROR', 'color: #f44336; font-weight: bold; font-size: 14px;');
                console.error('XHR Object:', xhr);
                console.error('Status:', status);
                console.error('Error:', error);
                console.error('Response Text:', xhr.responseText);
                console.error('Status Code:', xhr.status);

                alert('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡ Email à¸‹à¹‰à¸³\n\nStatus: ' + status + '\nError: ' + error + '\n\nğŸ’¡ à¹€à¸›à¸´à¸” Browser Console (F12) à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹ details');
                $btn.prop('disabled', false).html(originalText);
            }
        });
    });
});
</script>
</body>
</html>
