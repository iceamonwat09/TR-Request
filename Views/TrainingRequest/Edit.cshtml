@model TrainingRequestApp.Models.TrainingRequestEditViewModel
@using Microsoft.AspNetCore.Http
@{
    var userEmail = Context.Session.GetString("UserEmail") ?? "Guest";
    var userRole = Context.Session.GetString("UserRole") ?? "User";

    // ‚úÖ Multi-Mode Logic from Controller
    string pageMode = ViewBag.PageMode ?? "View"; // Edit, Approve, View, Admin
    bool canApprove = ViewBag.CanApprove ?? false;
    string approverRole = ViewBag.ApproverRole ?? "";
    bool isAdmin = ViewBag.IsAdmin ?? false;

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    bool canEdit = (pageMode == "Edit" || pageMode == "Admin" || pageMode == "HRDEdit"); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° HRDEdit
    bool isApproveMode = (pageMode == "Approve");
    bool isHRDEditMode = (pageMode == "HRDEdit"); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° variable ‡πÉ‡∏´‡∏°‡πà
    bool isViewMode = (pageMode == "View");

    // Disable form inputs based on mode
    string disabledAttr = (isApproveMode || isViewMode) ? "disabled" : "";
    string readonlyAttr = (isApproveMode || isViewMode) ? "readonly" : "";
}
<div class="container-fluid py-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); min-height: 100vh;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-11">
                @* ‡πÅ‡∏™‡∏î‡∏á Alert ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î *@
                @if (isApproveMode)
                {
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <strong><i class="fa fa-check-circle"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</strong><br>
                        ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approve), ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Revise), ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Reject) ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                else if (isViewMode)
                {
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong><i class="fa fa-eye"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</strong><br>
                        ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: @Model.Status)
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                else if (pageMode == "Edit")
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong><i class="fa fa-edit"></i> ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</strong><br>
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                else if (pageMode == "Admin")
                {
                    <div class="alert alert-primary alert-dismissible fade show" role="alert">
                        <strong><i class="fa fa-user-shield"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</strong><br>
                        ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                else if (isHRDEditMode)
                {
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong><i class="fa fa-user-edit"></i> ‡πÇ‡∏´‡∏°‡∏î HRD ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</strong><br>
                        ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                <div class="card shadow-lg border-0" style="border-radius: 15px;">
                    <div class="card-header bg-primary py-4 position-relative" style="border-radius: 15px 15px 0 0;">
                        <div class="position-absolute top-0 end-0 p-3">
                            <span class="badge bg-light text-primary fs-6">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: @Model.DocNo</span>
                            @if (isApproveMode)
                            {
                                <span class="badge bg-info fs-6 ms-2"><i class="fa fa-check-circle"></i> Approve Mode</span>
                            }
                            else if (isViewMode)
                            {
                                <span class="badge bg-warning text-dark fs-6 ms-2"><i class="fa fa-eye"></i> View Only</span>
                            }
                            else if (pageMode == "Admin")
                            {
                                <span class="badge bg-primary fs-6 ms-2"><i class="fa fa-user-shield"></i> Admin Mode</span>
                            }
                            else if (isHRDEditMode)
                            {
                                <span class="badge bg-warning text-dark fs-6 ms-2"><i class="fa fa-user-edit"></i> HRD Edit Mode</span>
                            }
                            else if (pageMode == "Edit")
                            {
                                <span class="badge bg-success fs-6 ms-2"><i class="fa fa-edit"></i> Edit Mode</span>
                            }
                        </div>
                        <h2 class="mb-0 text-white fw-bold text-center">
                            @if (isApproveMode)
                            {
                                <text>‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ö‡∏£‡∏°</text>
                            }
                            else if (canEdit)
                            {
                                <text>üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ö‡∏£‡∏°</text>
                            }
                            else
                            {
                                <text>üëÅÔ∏è ‡∏î‡∏π‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ö‡∏£‡∏°</text>
                            }
                        </h2>
                    </div>

                    <div class="card-body p-4">
                        <form id="trainingRequestForm" method="post" enctype="multipart/form-data">

                            <!-- ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-bold text-dark mb-3">
                                            üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                                        </label>
                                        <div class="d-flex gap-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="Company" asp-for="Company" value="F2-‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£" id="company1" @(Model.Company == "F2-‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£" ? "checked" : "") style="transform: scale(1.2);">
                                                <label class="form-check-label fw-medium" for="company1">
                                                    F2-‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="Company" asp-for="Company" value="F4-‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ" id="company2" @(Model.Company == "F4-‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ" ? "checked" : "") style="transform: scale(1.2);">
                                                <label class="form-check-label fw-medium" for="company2">
                                                    F4-‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-bold text-dark mb-3">
                                            üìö ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
                                        </label>
                                        <div class="d-flex gap-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="TrainingType" asp-for="TrainingType" value="Public" id="type1" @(Model.TrainingType == "Public" ? "checked" : "") style="transform: scale(1.2);">
                                                <label class="form-check-label fw-medium" for="type1">
                                                    Public
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="TrainingType" asp-for="TrainingType" value="In House" id="type2" @(Model.TrainingType == "In House" ? "checked" : "") style="transform: scale(1.2);">
                                                <label class="form-check-label fw-medium" for="type2">
                                                    In House
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏£‡∏Å - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="Factory" class="form-label fw-bold">üè≠ ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</label>
                                        <input asp-for="Factory" name="Factory" id="Factory" class="form-control form-control-lg" value="@Model.Factory" style="border-radius: 10px;" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label fw-bold">
                                            üìß CC.Mail
                                            <small class="text-muted">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•)</small>
                                        </label>
                                        <select id="ccEmailSelect"
                                                class="form-select form-select-lg"
                                                multiple
                                                style="width: 100%; border-radius: 10px;">
                                            <!-- Options ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å JavaScript -->
                                        </select>
                                        <!-- Hidden inputs ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                                        <div id="ccEmailHiddenInputs"></div>
                                        <span class="text-danger" asp-validation-for="CCEmail"></span>
                                    </div>
                                    <div class="form-group">
                                        <label asp-for="Department" class="form-label fw-bold">üè¢ ‡∏ù‡πà‡∏≤‡∏¢</label>
                                        <select asp-for="Department" id="departmentSelect" name="Department" class="form-select form-select-lg" style="border-radius: 10px;" required>
                                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢ --</option>
                                        </select>
                                        <span class="text-danger" asp-validation-for="Department"></span>
                                    </div>

                                    <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Position Dropdown ‡πÉ‡∏´‡∏°‡πà -->
                                    <div class="form-group">
                                        <label class="form-label fw-bold">üëî ‡πÅ‡∏ú‡∏ô‡∏Å</label>
                                        <select id="positionSelect" name="Position" class="form-select form-select-lg" style="border-radius: 10px;" disabled>
                                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô --</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label asp-for="StartDate" class="form-label fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏£‡∏°</label>
                                                <input asp-for="StartDate" id="StartDate" name="StartDate" class="form-control form-control-lg" type="date" value="@Model.StartDate?.ToString("yyyy-MM-dd")" style="border-radius: 10px;" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label asp-for="EndDate" class="form-label fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</label>
                                                <input asp-for="EndDate" id="EndDate" name="EndDate" class="form-control form-control-lg" type="date" value="@Model.EndDate?.ToString("yyyy-MM-dd")" style="border-radius: 10px;" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label asp-for="SeminarTitle" class="form-label fw-bold">üìñ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤</label>
                                        <input asp-for="SeminarTitle" id="SeminarTitle" name="SeminarTitle" class="form-control form-control-lg" value="@Model.SeminarTitle" style="border-radius: 10px;" />
                                    </div>

                                    <div class="form-group">
                                        <label asp-for="TrainingLocation" class="form-label fw-bold">üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°</label>
                                        <input asp-for="TrainingLocation" id="TrainingLocation" name="TrainingLocation" class="form-control form-control-lg" value="@Model.TrainingLocation" style="border-radius: 10px;" />
                                    </div>

                                    <div class="form-group">
                                        <label asp-for="Instructor" class="form-label fw-bold">üë®‚Äçüè´ ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£/‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</label>
                                        <input asp-for="Instructor" id="Instructor" name="Instructor" class="form-control form-control-lg" value="@Model.Instructor" style="border-radius: 10px;" />
                                    </div>
                                </div>

                                <!-- üí∞ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Public) - 2 ‡∏ä‡πà‡∏≠‡∏á -->
                                <div class="col-12 mt-4" id="budgetPublicCard" style="display: none;">
                                    <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                                        <div class="card-header bg-info text-white" style="border-radius: 12px 12px 0 0;">
                                            <h5 class="mb-0 fw-bold">üí∞ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Public)</h5>
                                        </div>
                                        <div class="card-body p-4">
                                            <div class="row g-3">
                                                <!-- ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô -->
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                                                    <input type="number" id="CostPerPerson" name="CostPerPerson" class="form-control form-control-lg budget-input-public" step="0.01" min="0" value="@Model.CostPerPerson" style="border-radius: 10px;" />
                                                </div>

                                                <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° -->
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">‚è∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</label>
                                                    <input type="number" name="TrainingHours" id="TrainingHours" class="form-control form-control-lg budget-input-public" min="0.5" step="0.5" value="@Model.TrainingHours" style="border-radius: 10px;" />
                                                </div>

                                                <!-- ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ -->
                                                <div class="col-12">
                                                    <hr class="my-3">
                                                    <div class="alert alert-success d-flex justify-content-between align-items-center" style="border-radius: 10px;">
                                                        <span class="fw-bold fs-5">üíµ ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó):</span>
                                                        <span class="fw-bold fs-4 text-success" id="totalCostDisplayPublic">0.00</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- üí∞ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (In House) - 7 ‡∏ä‡πà‡∏≠‡∏á -->
                                <div class="col-12 mt-4" id="budgetInHouseCard" style="display: none;">
                                    <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                                        <div class="card-header bg-warning text-dark" style="border-radius: 12px 12px 0 0;">
                                            <h5 class="mb-0 fw-bold">üí∞ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (In House)</h5>
                                        </div>
                                        <div class="card-body p-4">
                                            <div class="row g-3">


                                                <!-- ‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ -->
                                                <div class="col-md-6">
                                                    <label asp-for="RegistrationCost" class="form-label fw-bold">üìã ‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ (‡∏ö‡∏≤‡∏ó)</label>
                                                    <input asp-for="RegistrationCost" name="RegistrationCost" id="RegistrationCost" class="form-control form-control-lg budget-input" type="number" step="0.01" min="0" value="@Model.RegistrationCost" style="border-radius: 10px;" />
                                                </div>


                                                <!-- ‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ -->
                                                <div class="col-md-6">
                                                    <label asp-for="InstructorFee" class="form-label fw-bold">üë®‚Äçüè´ ‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ (‡∏ö‡∏≤‡∏ó)</label>
                                                    <input asp-for="InstructorFee" name="InstructorFee" id="InstructorFee" class="form-control form-control-lg budget-input-inhouse" type="number" step="0.01" min="0" value="@Model.InstructorFee" style="border-radius: 10px;" />
                                                </div>

                                                <!-- ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÅ‡∏°‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ -->
                                                <div class="col-md-6" style="display: none;">
                                                    <label class="form-label fw-bold">üíº ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÅ‡∏°‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ (‡∏ö‡∏≤‡∏ó)</label>
                                                    <input name="InstructorCommission" id="InstructorCommission" class="form-control form-control-lg budget-input-inhouse" type="number" step="0.01" min="0" value="0" style="border-radius: 10px;" />
                                                </div>

                                                <!-- ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
                                                <div class="col-md-6">
                                                    <label asp-for="EquipmentCost" class="form-label fw-bold">üõ†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏ö‡∏≤‡∏ó)</label>
                                                    <input asp-for="EquipmentCost" name="EquipmentCost" id="EquipmentCost" class="form-control form-control-lg budget-input-inhouse" type="number" step="0.01" min="0" value="@Model.EquipmentCost" style="border-radius: 10px;" />
                                                </div>

                                                <!-- ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ -->
                                                <div class="col-md-6">
                                                    <label asp-for="FoodCost" class="form-label fw-bold">üçΩÔ∏è ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</label>
                                                    <input asp-for="FoodCost" name="FoodCost" id="FoodCost" class="form-control form-control-lg budget-input-inhouse" type="number" step="0.01" min="0" value="@Model.FoodCost" style="border-radius: 10px;" />
                                                </div>

                                                <!-- ‡∏≠‡∏∑‡πà‡∏ô‡πÜ -->
                                                <div class="col-md-6">
                                                    <label asp-for="OtherCost" class="form-label fw-bold">üîß ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó)</label>
                                                    <input asp-for="OtherCost" name="OtherCost" id="OtherCost" class="form-control form-control-lg budget-input-inhouse" type="number" step="0.01" min="0" value="@Model.OtherCost" style="border-radius: 10px;" />
                                                </div>

                                                <!-- ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ -->
                                                <div class="col-md-6">
                                                    <label asp-for="OtherCostDescription" class="form-label fw-bold">üìù ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                                                    <input asp-for="OtherCostDescription" name="OtherCostDescription" class="form-control form-control-lg" value="@Model.OtherCostDescription" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ" style="border-radius: 10px;" />
                                                </div>

                                                <!-- ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ -->
                                                <!-- ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Read-only, ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) -->
                                                <div class="col-12">
                                                    <hr class="my-3">
                                                    <div class="alert alert-success d-flex justify-content-between align-items-center" style="border-radius: 10px;">
                                                        <span class="fw-bold fs-5">üíµ ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó):</span>
                                                        <span class="fw-bold fs-4 text-success" id="totalCostDisplay">0.00</span>
                                                    </div>
                                                    <input asp-for="TotalCost" name="TotalCost" type="hidden" id="totalCostInput" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- ‡∏õ‡∏¥‡∏î row g-3 ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 149 -->

                            <!-- üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏° (‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Public ‡πÅ‡∏•‡∏∞ In House) -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                                        <div class="card-header bg-primary text-white" style="border-radius: 12px 12px 0 0;">
                                            <h5 class="mb-0 fw-bold">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°</h5>
                                        </div>
                                        <div class="card-body p-4">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏° (‡∏Ñ‡∏ô)</label>
                                                    <input type="number" name="ParticipantCount" id="ParticipantCount" class="form-control form-control-lg" min="1" value="@Model.ParticipantCount" style="border-radius: 10px;" />
                                                    <small id="participantCountHelp" class="form-text text-muted">
                                                        <!-- ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á help text ‡∏ï‡∏≤‡∏° training type -->
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <script>
                                    // ============================================================
                                    // üéØ TRAINING REQUEST FORM - FINAL CORRECT VERSION
                                    // ============================================================
                                    document.addEventListener('DOMContentLoaded', function() {
                                        console.log('‚úÖ Training Request Form Script Loaded - Final Correct Version');

                                        // ============================================================
                                        // üìÖ STEP 3: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (Smart Date Handling)
                                        // ============================================================

                                        const startDateInput = document.getElementById('StartDate');
                                        const endDateInput = document.getElementById('EndDate');

                                        function addWorkingDays(date, days) {
                                            let currentDate = new Date(date);
                                            let addedDays = 0;

                                            while (addedDays < days) {
                                                currentDate.setDate(currentDate.getDate() + 1);
                                                if (currentDate.getDay() !== 0) {
                                                    addedDays++;
                                                }
                                            }

                                            return currentDate;
                                        }

                                        function setMinStartDate() {
                                            if (!startDateInput) return;

                                            const today = new Date();
                                            const minDate = addWorkingDays(today, 3);
                                            const minDateStr = minDate.toISOString().split('T')[0];
                                            startDateInput.setAttribute('min', minDateStr);

                                            console.log('üìÖ Min Start Date:', minDateStr);
                                        }

                                        if (startDateInput) {
                                            startDateInput.addEventListener('change', function() {
                                                const startDate = this.value;

                                                if (startDate) {
                                                    if (endDateInput) {
                                                        endDateInput.value = startDate;
                                                        endDateInput.setAttribute('min', startDate);
                                                    }

                                                    console.log('üìÖ Start Date Selected:', startDate);
                                                }
                                            });
                                        }

                                        if (endDateInput) {
                                            endDateInput.addEventListener('change', function() {
                                                const startDate = startDateInput ? startDateInput.value : '';
                                                const endDate = this.value;

                                                if (startDate && endDate && endDate < startDate) {
                                                    alert('‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏£‡∏°');
                                                    this.value = startDate;
                                                }
                                            });
                                        }

                                        setMinStartDate();

                                        // ============================================================
                                        // üî¢ STEP 2: Auto-clear ‡∏Ñ‡πà‡∏≤ 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Focus
                                        // ============================================================

                                        const autoClearInputs = document.querySelectorAll('.budget-input-public, .budget-input-inhouse');

                                        autoClearInputs.forEach(input => {
                                            input.addEventListener('focus', function() {
                                                if (this.value === '0' || this.value === '0.00') {
                                                    this.value = '';
                                                }
                                            });

                                            input.addEventListener('blur', function() {
                                                if (this.value.trim() === '') {
                                                    this.value = '0';
                                                }
                                            });
                                        });

                                        console.log('‚úÖ Auto-clear setup for', autoClearInputs.length, 'inputs');

                                        // ============================================================
                                        // üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Public) - ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                        // ============================================================

                                        const costPerPersonPublic = document.getElementById('CostPerPerson');
                                        const totalCostDisplayPublic = document.getElementById('totalCostDisplayPublic');

                                        // ‚úÖ Global function: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì Public
                                        window.calculateTotalBudgetPublic = function() {
                                            let costPerPerson = parseFloat(costPerPersonPublic?.value) || 0;

                                            // ‚úÖ ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (employeeManager.employees.length)
                                            let participantCount = 0;
                                            if (typeof employeeManager !== 'undefined' && employeeManager.employees) {
                                                participantCount = employeeManager.employees.length;
                                            }

                                            // ‚úÖ ‡∏Ñ‡∏π‡∏ì: ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                            let total = costPerPerson * participantCount;

                                            // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                                            if (totalCostDisplayPublic) {
                                                totalCostDisplayPublic.textContent = total.toLocaleString('th-TH', {
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2
                                                });
                                            }

                                            // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Hidden Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
                                            const totalCostInput = document.getElementById('totalCostInput');
                                            if (totalCostInput) {
                                                totalCostInput.value = total.toFixed(2);
                                            }

                                            console.log('üí∞ Total Budget (Public) [Edit Mode]:', {
                                                costPerPerson,
                                                participantCount,
                                                source: 'employeeManager.employees.length',
                                                total: total.toFixed(2),
                                                updatedInput: 'totalCostInput'
                                            });

                                            return total;
                                        };

                                        // ‚úÖ Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CostPerPerson
                                        if (costPerPersonPublic) {
                                            costPerPersonPublic.addEventListener('input', calculateTotalBudgetPublic);
                                            costPerPersonPublic.addEventListener('change', calculateTotalBudgetPublic);
                                        }

                                        // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Edit Mode)
                                        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ employeeManager ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
                                        setTimeout(function() {
                                            calculateTotalBudgetPublic();
                                        }, 500);

                                        // ============================================================
                                        // üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (In House) - 6 ‡∏ä‡πà‡∏≠‡∏á
                                        // ============================================================

                                        const budgetInputsInHouse = document.querySelectorAll('.budget-input-inhouse');
                                        const totalCostDisplayInHouse = document.getElementById('totalCostDisplayInHouse');

                                        function calculateTotalBudgetInHouse() {
                                            let total = 0;

                                            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å: ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ + ‡∏Ñ‡∏≠‡∏°‡πÅ‡∏°‡∏ô + ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå + ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ + ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                            budgetInputsInHouse.forEach(input => {
                                                const value = parseFloat(input.value) || 0;
                                                total += value;
                                            });

                                            if (totalCostDisplayInHouse) {
                                                totalCostDisplayInHouse.textContent = total.toLocaleString('th-TH', {
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2
                                                });
                                            }

                                            // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Hidden Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
                                            const totalCostInput = document.getElementById('totalCostInput');
                                            if (totalCostInput) {
                                                totalCostInput.value = total.toFixed(2);
                                            }

                                            console.log('üí∞ Total Budget (In House):', total.toFixed(2));

                                            return total;
                                        }

                                        budgetInputsInHouse.forEach(input => {
                                            input.addEventListener('input', calculateTotalBudgetInHouse);
                                            input.addEventListener('change', calculateTotalBudgetInHouse);
                                        });

                                        // ============================================================
                                        // üéØ STEP 4: ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
                                        // ============================================================

                                        const budgetPublicCard = document.getElementById('budgetPublicCard');
                                        const budgetInHouseCard = document.getElementById('budgetInHouseCard');
                                        const trainingHistorySection = document.getElementById('trainingHistorySection');
                                        const trainingTypeRadios = document.querySelectorAll('input[name="TrainingType"]');

                                        function toggleBudgetCards() {
                                            const selectedType = document.querySelector('input[name="TrainingType"]:checked');
                                            const participantCountField = document.getElementById('ParticipantCount');
                                            const participantCountHelp = document.getElementById('participantCountHelp');

                                            if (!selectedType) {
                                                if (budgetPublicCard) budgetPublicCard.style.display = 'none';
                                                if (budgetInHouseCard) budgetInHouseCard.style.display = 'none';
                                                if (trainingHistorySection) trainingHistorySection.style.display = 'none';
                                                console.log('üîÑ No training type selected - hiding all budget cards and training history table');
                                                return;
                                            }

                                            const typeValue = selectedType.value;

                                            if (typeValue === 'Public') {
                                                if (budgetPublicCard) budgetPublicCard.style.display = 'block';
                                                if (budgetInHouseCard) budgetInHouseCard.style.display = 'none';
                                                if (trainingHistorySection) trainingHistorySection.style.display = 'block';

                                                // ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public: ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô readonly ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á help text
                                                if (participantCountField) {
                                                    participantCountField.setAttribute('readonly', 'readonly');
                                                    participantCountField.style.backgroundColor = '#e9ecef';
                                                    participantCountField.style.cursor = 'not-allowed';
                                                }
                                                if (participantCountHelp) {
                                                    participantCountHelp.textContent = '‚ÑπÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
                                                }

                                                console.log('‚úÖ Showing Public budget card (2 fields) + Training History Table');
                                                calculateTotalBudgetPublic();
                                            } else if (typeValue === 'In House') {
                                                if (budgetPublicCard) budgetPublicCard.style.display = 'none';
                                                if (budgetInHouseCard) budgetInHouseCard.style.display = 'block';
                                                if (trainingHistorySection) trainingHistorySection.style.display = 'none';

                                                // ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö In House: ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
                                                if (participantCountField) {
                                                    participantCountField.removeAttribute('readonly');
                                                    participantCountField.style.backgroundColor = '';
                                                    participantCountField.style.cursor = '';
                                                    if (participantCountField.value === '0' || !participantCountField.value) {
                                                        participantCountField.value = '1';
                                                    }
                                                }
                                                if (participantCountHelp) {
                                                    participantCountHelp.textContent = '‚ÑπÔ∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏°‡∏≤‡∏¢';
                                                }

                                                console.log('‚úÖ Showing In House budget card (7 fields) + Hiding Training History Table');
                                                calculateTotalBudgetInHouse();
                                            }
                                        }

                                        trainingTypeRadios.forEach(radio => {
                                            radio.addEventListener('change', toggleBudgetCards);
                                        });

                                        toggleBudgetCards();

                                        // ============================================================
                                        // üìã Form Validation ‡πÅ‡∏•‡∏∞ Submit
                                        // ============================================================

                                        const form = document.getElementById('trainingRequestForm');

                                        if (form) {
                                            form.addEventListener('submit', function(e) {
                                                console.log('üìù Form Submit Started');

                                                const errors = [];

                                                const companyRadio = document.querySelector('input[name="Company"]:checked');
                                                if (!companyRadio) {
                                                    errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
                                                }

                                                const trainingTypeRadio = document.querySelector('input[name="TrainingType"]:checked');
                                                if (!trainingTypeRadio) {
                                                    errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°');
                                                }

                                                const startDate = startDateInput ? startDateInput.value : '';
                                                const endDate = endDateInput ? endDateInput.value : '';

                                                if (!startDate) {
                                                    errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏£‡∏°');
                                                }

                                                if (!endDate) {
                                                    errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°');
                                                }

                                                if (startDate && endDate && endDate < startDate) {
                                                    errors.push('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°');
                                                }

                                                const seminarTitle = document.getElementById('SeminarTitle');
                                                if (seminarTitle && !seminarTitle.value.trim()) {
                                                    errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤');
                                                }

                                                const trainingLocation = document.getElementById('TrainingLocation');
                                                if (trainingLocation && !trainingLocation.value.trim()) {
                                                    errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°');
                                                }

                                                if (errors.length > 0) {
                                                    e.preventDefault();
                                                    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n\n' + errors.join('\n'));
                                                    console.error('‚ùå Form validation failed:', errors);
                                                    return false;
                                                }

                                                const selectedType = document.querySelector('input[name="TrainingType"]:checked');
                                                if (selectedType && selectedType.value === 'Public') {
                                                    calculateTotalBudgetPublic();
                                                } else if (selectedType && selectedType.value === 'In House') {
                                                    calculateTotalBudgetInHouse();
                                                }

                                                console.log('‚úÖ Form validation passed');
                                                console.log('üì§ Submitting form...');

                                                return true;
                                            });
                                        }

                                        // ============================================================
                                        // ‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î
                                        // ============================================================

                                        console.log('===========================================');
                                        console.log('‚úÖ FINAL CORRECT VERSION LOADED');
                                        console.log('===========================================');
                                        console.log('üîµ Public: 2 fields (‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô + ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)');
                                        console.log('üü° In House: 7 fields');
                                        console.log('   1. ‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£');
                                        console.log('   2. ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÅ‡∏°‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ ‚úÖ');
                                        console.log('   3. ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå');
                                        console.log('   4. ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£');
                                        console.log('   5. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                                        console.log('   6. ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                                        console.log('   7. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏° ‚úÖ');
                                        console.log('===========================================');
                                        console.log('‚úÖ ‡∏ù‡πà‡∏≤‡∏¢/‡πÅ‡∏ú‡∏ô‡∏Å: Dropdown (‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Backend)');
                                        console.log('‚úÖ Auto-clear Zero - Ready');
                                        console.log('‚úÖ Smart Date Handling - Ready');
                                        console.log('‚úÖ Show/Hide Budget Cards - Ready');
                                        console.log('===========================================');
                                    });
                                </script>

                                <!-- ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° -->
                                <div class="form-group mt-4">
                                    <label class="form-label fw-bold">üéØ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤:</label>
                                    <div class="card mt-3" style="background-color: #f8f9fa; border-radius: 12px;">
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="form-check p-3" style="background-color: white; border-radius: 10px; border: 1px solid #dee2e6;">
                                                        <input class="form-check-input" type="radio" name="TrainingObjective" asp-for="TrainingObjective" value="‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç" id="objective1" @(Model.TrainingObjective == "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç" ? "checked" : "")>
                                                        <label class="form-check-label" for="objective1">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check p-3" style="background-color: white; border-radius: 10px; border: 1px solid #dee2e6;">
                                                        <input class="form-check-input" type="radio" name="TrainingObjective" asp-for="TrainingObjective" value="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" id="objective2" @(Model.TrainingObjective == "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û" ? "checked" : "")>
                                                        <label class="form-check-label" for="objective2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check p-3" style="background-color: white; border-radius: 10px; border: 1px solid #dee2e6;">
                                                        <input class="form-check-input" type="radio" name="TrainingObjective" asp-for="TrainingObjective" value="‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤" id="objective3" @(Model.TrainingObjective == "‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤" ? "checked" : "")>
                                                        <label class="form-check-label" for="objective3">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check p-3" style="background-color: white; border-radius: 10px; border: 1px solid #dee2e6;">
                                                        <input class="form-check-input" type="radio" name="TrainingObjective" asp-for="TrainingObjective" value="‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢/‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" id="objective4" @(Model.TrainingObjective == "‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢/‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" ? "checked" : "")>
                                                        <label class="form-check-label" for="objective4">‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢/‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check p-3" style="background-color: white; border-radius: 10px; border: 1px solid #dee2e6;">
                                                        <input class="form-check-input" type="radio" name="TrainingObjective" asp-for="TrainingObjective" value="‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ/‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏π‡πà‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô" id="objective5" @(Model.TrainingObjective == "‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ/‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏π‡πà‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô" ? "checked" : "")>
                                                        <label class="form-check-label" for="objective5">‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ/‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏π‡πà‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="p-3" style="background-color: white; border-radius: 10px; border: 1px solid #dee2e6;">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="TrainingObjective" asp-for="TrainingObjective" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" id="objective6" @(Model.TrainingObjective == "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ? "checked" : "")>
                                                            <label class="form-check-label" for="objective6">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                                                        </div>
                                                        <input type="text" class="form-control mt-2" asp-for="OtherObjective" id="OtherObjective" value="@Model.OtherObjective" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'" style="border-radius: 8px;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ‡∏ú‡∏•‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö -->
                                <div class="form-group mt-4">
                                    <label asp-for="ExpectedOutcome" class="form-label fw-bold">üéØ ‡∏ú‡∏•‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</label>
                                    <textarea asp-for="ExpectedOutcome" name="ExpectedOutcome" id="ExpectedOutcome" class="form-control" rows="3" style="border-radius: 10px;">@Model.ExpectedOutcome</textarea>
                                </div>

                                <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° -->
                                <div class="mt-5" id="trainingHistorySection">
                                    <div class="card border-0 shadow-lg" style="border-radius: 15px;">
                                        <div class="card-header bg-secondary py-3" style="border-radius: 15px 15px 0 0;">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h4 class="mb-0 text-white fw-bold">
                                                    üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                                </h4>
                                                <div>
                                                    <button type="button" class="btn btn-info text-white me-2" id="recalculateBtn" title="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                                                        <i class="fas fa-sync-alt me-1"></i>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
                                                    </button>
                                                    <button type="button" class="btn add-employee-btn text-white" data-bs-toggle="modal" data-bs-target="#employeeSearchModal">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card-body p-0">
                                            <!-- ‚ö†Ô∏è ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                                            @if (Model.Employees != null && Model.Employees.Any())
                                            {
                                                <div class="text-center mx-3 mt-3 mb-2" id="outdatedWarningContainer">
                                                    <button type="button" class="btn btn-info" id="outdatedWarning">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà @Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")
                                                        <span class="ms-1">(‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</span>
                                                    </button>
                                                </div>
                                            }
                                            <div class="table-responsive">
                                                <table class="table table-bordered mb-0" style="font-size: 0.9rem;" id="employeeTable">
                                                    <thead>
                                                        <tr class="table-primary">
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 80px; vertical-align: middle;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 100px; vertical-align: middle;">‡∏£‡∏´‡∏±‡∏™</th>
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 150px; vertical-align: middle;">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 120px; vertical-align: middle;">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                                            <th class="text-center py-3 fw-bold border-2" colspan="2" style="background-color: #e3f2fd; min-width: 200px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ</th>
                                                            <th class="text-center py-3 fw-bold border-2" colspan="2" style="background-color: #f3e5f5; min-width: 200px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ</th>
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 140px; vertical-align: middle;">
                                                                ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠(‡∏ù‡πà‡∏≤‡∏¢)<br>
                                                                <small id="departmentQhoursText">(‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ 0 ‡∏ä‡∏°./‡∏õ‡∏µ)</small>
                                                            </th>
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 140px; vertical-align: middle;">
                                                                ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠(‡∏ù‡πà‡∏≤‡∏¢)<br>
                                                                <small id="departmentQuotaText">(‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ 0 ‡∏ö./‡∏õ‡∏µ)</small>
                                                            </th>
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 160px; vertical-align: middle;">
                                                                ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏ö‡∏£‡∏°<br>
                                                                <small>‡∏ï‡∏•‡∏≠‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô</small>
                                                            </th>
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 120px; vertical-align: middle;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                                            <th class="text-center py-3 fw-bold border-2" style="min-width: 80px; vertical-align: middle;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                                        </tr>
                                                        <tr class="table-light">
                                                            <th colspan="4" class="p-3 border-2"></th>
                                                            <th class="text-center py-2 fw-semibold border-2" style="background-color: #e3f2fd;">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏™‡∏∞‡∏™‡∏°‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</th>
                                                            <th class="text-center py-2 fw-semibold border-2" style="background-color: #e3f2fd;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</th>
                                                            <th class="text-center py-2 fw-semibold border-2" style="background-color: #f3e5f5;">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ</th>
                                                            <th class="text-center py-2 fw-semibold border-2" style="background-color: #f3e5f5;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ</th>
                                                            <th colspan="5" class="p-3 border-2"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="employeeTableBody">
                                                        <!-- Dynamic rows will be inserted here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
                                <div class="form-group mt-4">
                                    <label asp-for="URLSource" class="form-label fw-bold">üîó ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤ URL (‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</label>
                                    <input asp-for="URLSource" name="URLSource" id="URLSource" class="form-control form-control-lg" type="url" value="@Model.URLSource" placeholder="https://example.com" onkeypress="return false;" style="border-radius: 10px;" />
                                </div>

                                <div class="form-group">
                                    <label asp-for="AdditionalNotes" class="form-label fw-bold">üìù ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ HR ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                    <textarea asp-for="AdditionalNotes" name="AdditionalNotes" id="AdditionalNotes" class="form-control" rows="3" style="border-radius: 10px;">@Model.AdditionalNotes</textarea>
                                </div>

                                <div class="form-group mt-4">
                                    <label asp-for="AttachedFiles" class="form-label fw-bold">üìé ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</label>
                                    <input asp-for="AttachedFiles" id="AttachedFiles" class="form-control form-control-lg" type="file" multiple style="border-radius: 10px;" />
                                    <small class="form-text text-muted">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ (PDF, Word, Excel, ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û, ZIP)</small>
                                </div>

                                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà -->
                                <div class="form-group mt-3" id="attachmentsSection" style="display: none;">
                                    <label class="form-label fw-bold">üìÇ ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                                    <div id="attachmentsList" class="list-group">
                                        <!-- ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                                    </div>
                                </div>

                                <!-- ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1: Section Manager -->
                                <hr class="my-4">
                                <h5 class="fw-bold mb-3">üë§ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1: Section Manager</h5>

                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Section Manager</label>
                                        <select id="sectionManagerSelect" class="form-select form-select-lg" style="width: 100%; border-radius: 10px;" required>
                                            <option value="">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</option>
                                            <option value="‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                                        </select>
                                        <input type="hidden" id="sectionManagerIdHidden" name="SectionManagerId" value="@Model.SectionManagerId" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                        <input type="text" name="Status_SectionManager" class="form-control form-control-lg" value="@Model.Status_SectionManager" readonly style="background-color: #e9ecef;" />
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
                                        <textarea name="Comment_SectionManager" class="form-control form-control-lg" rows="2" readonly style="background-color: #e9ecef;">@Model.Comment_SectionManager</textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                                        <input type="text" name="ApproveInfo_SectionManager" class="form-control form-control-lg" value="@Model.ApproveInfo_SectionManager" readonly style="background-color: #e9ecef;" />
                                    </div>
                                </div>

                                <!-- ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2: Department Manager -->
                                <hr class="my-4">
                                <h5 class="fw-bold mb-3">üë§ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2: Department Manager</h5>

                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Department Manager</label>
                                        <select id="departmentManagerSelect" class="form-select form-select-lg" style="width: 100%; border-radius: 10px;" required>
                                            <option value="">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</option>
                                            <option value="‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                                        </select>
                                        <input type="hidden" id="departmentManagerIdHidden" name="DepartmentManagerId" value="@Model.DepartmentManagerId" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                        <input type="text" name="Status_DepartmentManager" class="form-control form-control-lg" value="@Model.Status_DepartmentManager" readonly style="background-color: #e9ecef;" />
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
                                        <textarea name="Comment_DepartmentManager" class="form-control form-control-lg" rows="2" readonly style="background-color: #e9ecef;">@Model.Comment_DepartmentManager</textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                                        <input type="text" name="ApproveInfo_DepartmentManager" class="form-control form-control-lg" value="@Model.ApproveInfo_DepartmentManager" readonly style="background-color: #e9ecef;" />
                                    </div>
                                </div>

                                <!-- ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 3: HRD Admin -->
                                <hr class="my-4">
                                <h5 class="fw-bold mb-3">üë§ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 3: HRD Admin (‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</h5>

                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">HRD Admin</label>
                                        <input type="text" class="form-control form-control-lg" value="@Model.HRDAdminId" readonly style="background-color: #e9ecef; border-radius: 10px;" />
                                        <input type="hidden" name="HRDAdminId" value="@Model.HRDAdminId" />
                                        <small class="text-muted">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                        <input type="text" name="Status_HRDAdmin" class="form-control form-control-lg" value="@Model.Status_HRDAdmin" readonly style="background-color: #e9ecef;" />
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
                                        <textarea name="Comment_HRDAdmin" class="form-control form-control-lg" rows="2" readonly style="background-color: #e9ecef;">@Model.Comment_HRDAdmin</textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                                        <input type="text" name="ApproveInfo_HRDAdmin" class="form-control form-control-lg" value="@Model.ApproveInfo_HRDAdmin" readonly style="background-color: #e9ecef;" />
                                    </div>
                                </div>

                                <!-- ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 4: HRD Confirmation -->
                                <hr class="my-4">
                                <h5 class="fw-bold mb-3">üë§ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 4: HRD Confirmation (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°)</h5>

                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">HRD Confirmation</label>
                                        <input type="text" class="form-control form-control-lg" value="@Model.HRDConfirmationId" readonly style="background-color: #e9ecef; border-radius: 10px;" />
                                        <input type="hidden" name="HRDConfirmationId" value="@Model.HRDConfirmationId" />
                                        <small class="text-muted">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                        <input type="text" name="Status_HRDConfirmation" class="form-control form-control-lg" value="@Model.Status_HRDConfirmation" readonly style="background-color: #e9ecef;" />
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
                                        <textarea name="Comment_HRDConfirmation" class="form-control form-control-lg" rows="2" readonly style="background-color: #e9ecef;">@Model.Comment_HRDConfirmation</textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                                        <input type="text" name="ApproveInfo_HRDConfirmation" class="form-control form-control-lg" value="@Model.ApproveInfo_HRDConfirmation" readonly style="background-color: #e9ecef;" />
                                    </div>
                                </div>

                                <!-- ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 5: HRD Confirmation -->
                                <hr class="my-4">
                                <h5 class="fw-bold mb-3">üë§ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 5: Managing Director</h5>

                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Managing Director</label>
                                        <select id="managingDirectorSelect" class="form-select form-select-lg" style="width: 100%; border-radius: 10px;" required>
                                            <option value="">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</option>
                                            <option value="‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                                        </select>
                                        <input type="hidden" id="managingDirectorIdHidden" name="ManagingDirectorId" value="@Model.ManagingDirectorId" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                        <input type="text" name="Status_ManagingDirector" class="form-control form-control-lg" value="@Model.Status_ManagingDirector" readonly style="background-color: #e9ecef;" />
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
                                        <textarea name="Comment_ManagingDirector" class="form-control form-control-lg" rows="2" readonly style="background-color: #e9ecef;">@Model.Comment_ManagingDirector</textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                                        <input type="text" name="ApproveInfo_ManagingDirector" class="form-control form-control-lg" value="@Model.ApproveInfo_ManagingDirector" readonly style="background-color: #e9ecef;" />
                                    </div>
                                </div>

                                <!-- ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 6: Deputy Managing Director -->
                                <hr class="my-4">
                                <h5 class="fw-bold mb-3">üë§ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 6: Deputy Managing Director</h5>

                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Deputy Managing Director</label>
                                        <select id="deputyManagingDirectorSelect" class="form-select form-select-lg" style="width: 100%; border-radius: 10px;" required>
                                            <option value="">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</option>
                                            <option value="‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                                        </select>
                                        <input type="hidden" id="deputyManagingDirectorIdHidden" name="DeputyManagingDirectorId" value="@Model.DeputyManagingDirectorId" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                        <input type="text" name="Status_DeputyManagingDirector" class="form-control form-control-lg" value="@Model.Status_DeputyManagingDirector" readonly style="background-color: #e9ecef;" />
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
                                        <textarea name="Comment_DeputyManagingDirector" class="form-control form-control-lg" rows="2" readonly style="background-color: #e9ecef;">@Model.Comment_DeputyManagingDirector</textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                                        <input type="text" name="ApproveInfo_DeputyManagingDirector" class="form-control form-control-lg" value="@Model.ApproveInfo_DeputyManagingDirector" readonly style="background-color: #e9ecef;" />
                                    </div>
                                </div>

                                @* ==================== HRD Record Section (Admin/System Admin/HRD Admin/HRD Confirmation Only) ==================== *@
                                @{
                                    bool isHRDAdmin = string.Equals(userEmail, Model.HRDAdminId, StringComparison.OrdinalIgnoreCase);
                                    bool isHRDConfirmation = string.Equals(userEmail, Model.HRDConfirmationId, StringComparison.OrdinalIgnoreCase);
                                    bool canEditHRDSection = isAdmin ||
                                                             userRole.Contains("System Admin", StringComparison.OrdinalIgnoreCase) ||
                                                             isHRDAdmin ||
                                                             isHRDConfirmation;
                                }

                                @if (canEditHRDSection)
                                {
                                    <hr class="my-5">
                                    <div class="card shadow-sm border-warning mb-4" style="border-radius: 12px; border-width: 2px;">
                                        <div class="card-header bg-warning text-dark py-3" style="border-radius: 10px 10px 0 0;">
                                            <h5 class="mb-0 fw-bold">
                                                <i class="fa fa-clipboard-check"></i>
                                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô HRD ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                                <small class="text-muted">(‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin/System Admin/HRD Admin/HRD Confirmation)</small>
                                            </h5>
                                        </div>
                                        <div class="card-body p-4" style="background-color: #fffbf0;">
                                            @* üîç Debug: Log HRD Model values *@
                                            <script>
                                                console.log('üìã HRD Fields from Model:');
                                                console.log('   ContactDate: @Model.HRD_ContactDate');
                                                console.log('   ContactPerson: @Model.HRD_ContactPerson');
                                                console.log('   PaymentDate: @Model.HRD_PaymentDate');
                                                console.log('   PaymentMethod: @Model.HRD_PaymentMethod');
                                                console.log('   RecorderSignature: @Model.HRD_RecorderSignature');
                                            </script>

                                            <div class="row g-3">
                                                <!-- ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô -->
                                                <div class="col-md-6">
                                                    <label asp-for="HRD_ContactDate" class="form-label fw-bold">
                                                        üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô/‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô : ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                                                    </label>
                                                    <input asp-for="HRD_ContactDate" name="HRD_ContactDate" type="date" class="form-control form-control-lg"
                                                           value="@Model.HRD_ContactDate?.ToString("yyyy-MM-dd")" style="border-radius: 8px;" />
                                                </div>

                                                <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ -->
                                                <div class="col-md-6">
                                                    <label asp-for="HRD_ContactPerson" class="form-label fw-bold">
                                                        üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢
                                                    </label>
                                                    <input asp-for="HRD_ContactPerson" name="HRD_ContactPerson" type="text" class="form-control form-control-lg"
                                                           value="@Model.HRD_ContactPerson" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" style="border-radius: 8px;" />
                                                </div>

                                                <!-- ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
                                                <div class="col-md-6">
                                                    <label asp-for="HRD_PaymentDate" class="form-label fw-bold">
                                                        üí∞ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô : ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                                                    </label>
                                                    <input asp-for="HRD_PaymentDate" name="HRD_PaymentDate" type="date" class="form-control form-control-lg"
                                                           value="@Model.HRD_PaymentDate?.ToString("yyyy-MM-dd")" style="border-radius: 8px;" />
                                                </div>

                                                <!-- ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">üí≥ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                                                    <div class="d-flex gap-4 mt-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                   name="HRD_PaymentMethod" asp-for="HRD_PaymentMethod"
                                                                   value="Check" id="payCheck"
                                                                   @(Model.HRD_PaymentMethod == "Check" ? "checked" : "")
                                                                   style="transform: scale(1.2);">
                                                            <label class="form-check-label fw-medium" for="payCheck">
                                                                ‡πÄ‡∏ä‡πá‡∏Ñ/‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                   name="HRD_PaymentMethod" asp-for="HRD_PaymentMethod"
                                                                   value="Cash" id="payCash"
                                                                   @(Model.HRD_PaymentMethod == "Cash" ? "checked" : "")
                                                                   style="transform: scale(1.2);">
                                                            <label class="form-check-label fw-medium" for="payCash">
                                                                ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
                                                <div class="col-md-12">
                                                    <label asp-for="HRD_RecorderSignature" class="form-label fw-bold">
                                                        ‚úçÔ∏è ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ : ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                                    </label>
                                                    <input asp-for="HRD_RecorderSignature" name="HRD_RecorderSignature" type="text" class="form-control form-control-lg"
                                                           value="@Model.HRD_RecorderSignature" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" style="border-radius: 8px;" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }

                                <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö Multi-Mode -->
                                <div class="text-center mt-5">
                                    @if (isApproveMode)
                                    {
                                        <!-- Approve Mode: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Approve / Revise / Reject + Comment -->
                                        <div class="approval-section border rounded p-4 mb-4" style="background-color: #f8f9fa;">
                                            <h5 class="text-center mb-4">üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (Optional for Approve, Required for Revise/Reject)</h5>
                                            <textarea id="approvalComment" class="form-control form-control-lg mb-4" rows="4" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."></textarea>

                                            <div class="d-flex justify-content-center gap-3">
                                                <button type="button" id="btnApprove" class="btn btn-success btn-lg px-5 py-3 fw-bold" style="border-radius: 25px;">
                                                    ‚úÖ Approve
                                                </button>
                                                <button type="button" id="btnRevise" class="btn btn-warning btn-lg px-5 py-3 fw-bold" style="border-radius: 25px;">
                                                    üîÑ Revise
                                                </button>
                                                <button type="button" id="btnReject" class="btn btn-danger btn-lg px-5 py-3 fw-bold" style="border-radius: 25px;">
                                                    ‚ùå Reject
                                                </button>
                                            </div>
                                        </div>
                                        <a href="/TrainingRequest/ApprovalFlow?docNo=@Model.DocNo" class="btn btn-info btn-lg px-4 py-2" style="border-radius: 20px;">
                                            üìä ‡∏î‡∏π Approval Timeline
                                        </a>
                                        <a href="/Home/MonthlyRequests" class="btn btn-secondary btn-lg px-4 py-2 ms-2" style="border-radius: 20px;">
                                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
                                        </a>
                                    }
                                    else if (isHRDEditMode)
                                    {
                                        <!-- HRD Edit Mode: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Save + Approve/Revise/Reject -->

                                        <!-- 1Ô∏è‚É£ ‡∏õ‡∏∏‡πà‡∏° Save ‡∏Å‡πà‡∏≠‡∏ô -->
                                        <button type="submit" class="btn btn-primary btn-lg text-white px-5 py-3 fw-bold mb-4" style="border-radius: 25px; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);">
                                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                        </button>

                                        <!-- 2Ô∏è‚É£ ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Save ‡πÅ‡∏•‡∏∞ Approve -->
                                        <hr class="my-4" style="border-top: 2px solid #dee2e6;">

                                        <!-- 3Ô∏è‚É£ ‡∏™‡πà‡∏ß‡∏ô Approval (Approve/Revise/Reject + Comment) -->
                                        <div class="approval-section border rounded p-4 mb-4" style="background-color: #f8f9fa;">
                                            <h5 class="text-center mb-4">üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (Optional for Approve, Required for Revise/Reject)</h5>
                                            <textarea id="approvalComment" class="form-control form-control-lg mb-4" rows="4" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."></textarea>

                                            <div class="d-flex justify-content-center gap-3">
                                                <button type="button" id="btnApprove" class="btn btn-success btn-lg px-5 py-3 fw-bold" style="border-radius: 25px;">
                                                    ‚úÖ Approve
                                                </button>
                                                <button type="button" id="btnRevise" class="btn btn-warning btn-lg px-5 py-3 fw-bold" style="border-radius: 25px;">
                                                    üîÑ Revise
                                                </button>
                                                <button type="button" id="btnReject" class="btn btn-danger btn-lg px-5 py-3 fw-bold" style="border-radius: 25px;">
                                                    ‚ùå Reject
                                                </button>
                                            </div>
                                        </div>

                                        <!-- 4Ô∏è‚É£ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
                                        <a href="/TrainingRequest/ApprovalFlow?docNo=@Model.DocNo" class="btn btn-info btn-lg px-4 py-2" style="border-radius: 20px;">
                                            üìä ‡∏î‡∏π Approval Timeline
                                        </a>
                                        <a href="/Home/MonthlyRequests" class="btn btn-secondary btn-lg px-4 py-2 ms-2" style="border-radius: 20px;">
                                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
                                        </a>
                                    }
                                    else if (canEdit)
                                    {
                                        <!-- Edit Mode / Admin Mode: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Save -->
                                        <button type="submit" class="btn btn-primary btn-lg text-white px-5 py-3 fw-bold" style="border-radius: 25px; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);">
                                            üíæ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                        </button>
                                        <a href="/TrainingRequest/ApprovalFlow?docNo=@Model.DocNo" class="btn btn-info btn-lg px-4 py-2 ms-2" style="border-radius: 20px;">
                                            üìä ‡∏î‡∏π Approval Timeline
                                        </a>
                                        <a href="/Home/MonthlyRequests" class="btn btn-secondary btn-lg px-4 py-2 ms-2" style="border-radius: 20px;">
                                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
                                        </a>
                                    }
                                    else
                                    {
                                        <!-- View Mode: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Back ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô -->
                                        <a href="/TrainingRequest/ApprovalFlow?docNo=@Model.DocNo" class="btn btn-info btn-lg px-5 py-3" style="border-radius: 25px;">
                                            üìä ‡∏î‡∏π Approval Timeline
                                        </a>
                                        <a href="/Home/MonthlyRequests" class="btn btn-secondary btn-lg px-5 py-3 fw-bold ms-2" style="border-radius: 25px;">
                                            <i class="fa fa-arrow-left me-2"></i>‡∏Å‡∏•‡∏±‡∏ö
                                        </a>
                                    }
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (isApproveMode || isHRDEditMode)
{
    <!-- ‚úÖ JavaScript for Approval Actions -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    $(document).ready(function() {
        const docNo = '@Model.DocNo';
        const isHRDEditMode = @Json.Serialize(isHRDEditMode); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° HRDEdit Mode flag

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô double-click
        let isProcessing = false;

        // ‚≠ê Track form changes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HRDEdit Mode
        let formChanged = false;
        if (isHRDEditMode) {
            $('#trainingRequestForm :input').on('change', function() {
                formChanged = true;
            });
        }

        function handleApprovalAction(action) {
            if (isProcessing) {
                alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
                return;
            }

            // ‚≠ê HRDEdit Mode: ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
            if (isHRDEditMode && action === 'Approve') {
                const confirmMsg = formChanged
                    ? '‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)'
                    : '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';

                if (!confirm(confirmMsg)) {
                    return;
                }
            }

            const comment = $('#approvalComment').val().trim();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Revise/Reject ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Comment
            if ((action === 'Revise' || action === 'Reject') && !comment) {
                alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ ${action}`);
                $('#approvalComment').focus();
                return;
            }

            // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà HRDEdit Mode ‡∏Å‡∏±‡∏ö Approve ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
            if (!(isHRDEditMode && action === 'Approve')) {
                const confirmMsg = action === 'Approve'
                    ? '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?'
                    : (action === 'Revise'
                        ? '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?'
                        : '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');

                if (!confirm(confirmMsg)) {
                    return;
                }
            }

            isProcessing = true;

            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            $('#btnApprove, #btnRevise, #btnReject').prop('disabled', true);
            const $btn = action === 'Approve' ? $('#btnApprove') : (action === 'Revise' ? $('#btnRevise') : $('#btnReject'));
            const originalText = $btn.html();
            $btn.html('<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...');

            $.ajax({
                url: '/TrainingRequest/Approve',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    docNo: docNo,
                    action: action,
                    comment: comment
                }),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.href = '/Home';
                    } else {
                        alert(response.message);
                        isProcessing = false;
                        $('#btnApprove, #btnRevise, #btnReject').prop('disabled', false);
                        $btn.html(originalText);
                    }
                },
                error: function(xhr, status, error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error);
                    isProcessing = false;
                    $('#btnApprove, #btnRevise, #btnReject').prop('disabled', false);
                    $btn.html(originalText);
                }
            });
        }

        $('#btnApprove').click(function() {
            handleApprovalAction('Approve');
        });

        $('#btnRevise').click(function() {
            handleApprovalAction('Revise');
        });

        $('#btnReject').click(function() {
            handleApprovalAction('Reject');
        });
    });
    </script>
}

<!-- Employee Search Modal -->
<div class="modal fade" id="employeeSearchModal" tabindex="-1" aria-labelledby="employeeSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 15px;">
            <div class="modal-header bg-primary text-white" style="border-radius: 15px 15px 0 0;">
                <h5 class="modal-title" id="employeeSearchModalLabel">
                    <i class="fas fa-search me-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="employeeCode" class="form-label fw-bold">üÜî ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                        <input type="text" class="form-control form-control-lg" id="employeeCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" style="border-radius: 10px;">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-success btn-lg w-100" id="searchEmployeeBtn" style="border-radius: 10px;">
                            <i class="fas fa-search me-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        </button>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div class="text-center mt-4 loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>

                <!-- Employee Information Display -->
                <div class="mt-4" id="employeeInfoSection" style="display: none;">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-user me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                                    <p class="form-control-plaintext fw-semibold" id="displayEmpCode">-</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
                                    <p class="form-control-plaintext fw-semibold" id="displayFullName">-</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">‡πÅ‡∏ú‡∏ô‡∏Å:</label>
                                    <p class="form-control-plaintext fw-semibold" id="displayPosition">-</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">‡∏£‡∏∞‡∏î‡∏±‡∏ö:</label>
                                    <p class="form-control-plaintext fw-semibold" id="displayLevel">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div class="alert alert-danger mt-4" id="errorMessage" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorText">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="button" class="btn btn-primary" id="addEmployeeBtn" disabled>
                    <i class="fas fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>
</div>




<!-- CSS ‡πÅ‡∏•‡∏∞ JavaScript -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<!-- ‚úÖ Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(13, 110, 253, 0.5) !important;
        transition: all 0.3s ease;
    }

    .table th, .table td {
        vertical-align: middle;
    }

    .table-bordered > :not(caption) > * > * {
        border-width: 2px;
    }

    .card {
        transition: all 0.3s ease;
    }

    .form-control:hover {
        border-color: #86b7fe;
        transition: all 0.3s ease;
    }

    .badge {
        transition: all 0.3s ease;
    }

        .badge:hover {
            transform: scale(1.05);
        }

    .form-check-input {
        transition: all 0.3s ease;
    }

        .form-check-input:hover {
            transform: scale(1.1);
        }

    .table-bordered {
        border: 3px solid #dee2e6;
    }

    .border-2 {
        border-width: 2px !important;
        border-color: #6c757d !important;
    }

    .add-employee-btn {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

        .add-employee-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
        }

    .employee-row {
        animation: fadeInDown 0.5s ease-out;
    }

    @@keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .loading-spinner {
        display: none;
    }

    /* ===== Select2 Custom Styling ===== */
    .select2-container--bootstrap-5 .select2-selection--multiple {
        min-height: 48px !important;
        border-radius: 10px !important;
        padding: 8px !important;
        border: 1px solid #ced4da !important;
    }

        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
            background-color: #007bff !important;
            border: none !important;
            color: white !important;
            border-radius: 6px !important;
            padding: 5px 10px !important;
            margin: 3px !important;
            font-size: 14px !important;
        }

        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
            color: white !important;
            margin-right: 5px !important;
            font-weight: bold !important;
        }

            .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove:hover {
                color: #ff4444 !important;
            }

    .select2-results__option {
        padding: 10px !important;
    }

        .select2-results__option strong {
            color: #007bff;
            display: block;
            margin-bottom: 3px;
        }

        .select2-results__option small {
            color: #6c757d;
        }

</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ‚úÖ jQuery (Select2 ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- ‚úÖ Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
        // ====================================================================
        // üîí Read-only Mode - Disable ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤ User ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
        // ====================================================================
        const canEdit = @(canEdit.ToString().ToLower());
        const isApproveMode = @(isApproveMode.ToString().ToLower());  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ

        if (!canEdit) {
            console.log('üîí Read-only Mode: Disabling form fields (Approve Mode: ' + isApproveMode + ')');

            // ‚≠ê Disable input, select, textarea ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô readonly ‡πÅ‡∏•‡∏∞ approvalComment ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
            document.querySelectorAll('input:not([readonly]), select:not([readonly]), textarea:not([readonly])').forEach(el => {
                // ‚≠ê ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô approvalComment ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                if (isApproveMode && el.id === 'approvalComment') {
                    return; // ‡πÑ‡∏°‡πà disable comment box
                }

                el.disabled = true;
                el.style.cursor = 'not-allowed';
            });

            // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Disable buttons ‡πÅ‡∏ï‡πà‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            document.querySelectorAll('button:not([data-bs-dismiss])').forEach(btn => {
                // ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
                // 1. ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô alert
                // 2. ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö (btn-secondary)
                // 3. ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (btnApprove, btnRevise, btnReject) ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                const isApprovalButton = btn.id === 'btnApprove' || btn.id === 'btnRevise' || btn.id === 'btnReject';
                const shouldSkip = btn.closest('.alert') ||
                                  btn.classList.contains('btn-secondary') ||
                                  (isApproveMode && isApprovalButton);  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ

                if (!shouldSkip) {
                    btn.disabled = true;
                    btn.style.cursor = 'not-allowed';
                }
            });

            console.log('‚úÖ Form fields disabled. Approval buttons: ' + (isApproveMode ? 'ENABLED' : 'DISABLED'));

            // ‚≠ê Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Approve Mode
            if (isApproveMode) {
                console.log('‚úÖ Approve Mode: Approval buttons and comment should be ENABLED');
                setTimeout(() => {
                    console.log('   - #btnApprove disabled:', document.getElementById('btnApprove')?.disabled);
                    console.log('   - #btnRevise disabled:', document.getElementById('btnRevise')?.disabled);
                    console.log('   - #btnReject disabled:', document.getElementById('btnReject')?.disabled);
                    console.log('   - #approvalComment disabled:', document.getElementById('approvalComment')?.disabled);
                    console.log('   - #approvalComment readonly:', document.getElementById('approvalComment')?.readOnly);
                }, 100);
            }
        }

        // ====================================================================
        // üîÑ Reset ‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡∏∞ Disable (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
        // ====================================================================
        function resetUnusedFields() {
            const trainingType = document.querySelector('input[name="TrainingType"]:checked')?.value;

            console.log(`üîÑ Training Type Changed: ${trainingType}`);

            if (trainingType === 'Public') {
                // Enable Public fields
                const publicFields = ['CostPerPerson', 'TrainingHours'];
                publicFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.disabled = false;
                        console.log(`‚úÖ Enabled: ${id}`);
                    }
                });

                // Disable In House fields
                const inHouseFields = [
                    'RegistrationCost',
                    'InstructorFee',
                    'InstructorCommission',
                    'EquipmentCost',
                    'FoodCost',
                    'OtherCost'
                ];

                inHouseFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = '0';
                        input.disabled = true;
                        console.log(`‚úÖ Reset & Disabled: ${id}`);
                    }
                });

                console.log('‚úÖ Public enabled, In House disabled');

            } else if (trainingType === 'In House') {
                // Enable In House fields
                const inHouseFields = [
                    'RegistrationCost',
                    'InstructorFee',
                    'InstructorCommission',
                    'EquipmentCost',
                    'FoodCost',
                    'OtherCost'
                ];

                inHouseFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.disabled = false;
                        console.log(`‚úÖ Enabled: ${id}`);
                    }
                });

                // Disable Public fields
                const publicFields = ['CostPerPerson', 'TrainingHours'];

                publicFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = '0';
                        input.disabled = true; // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ validation
                        console.log(`‚úÖ Reset & Disabled: ${id}`);
                    }
                });

                console.log('‚úÖ In House enabled, Public disabled');
            }

            calculateTotalCost();
        }

        // ====================================================================
        // üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Version ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)
        // ====================================================================
        function calculateTotalCost() {
            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const trainingTypeRadio = document.querySelector('input[name="TrainingType"]:checked');
                const trainingType = trainingTypeRadio?.value || '';

                let total = 0;

                if (trainingType === 'Public') {
                    // ========================================
                    // üìå Public: ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    // ========================================
                    const costPerPerson = parseFloat(document.getElementById('CostPerPerson')?.value || 0);

                    // ‚úÖ Public ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (employeeManager.employees.length)
                    let participantCount = 0;
                    if (typeof employeeManager !== 'undefined' && employeeManager.employees) {
                        participantCount = employeeManager.employees.length;
                    }

                    // ‚úÖ Public ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏π‡∏ì‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
                    total = costPerPerson * participantCount;

                    console.log('üí∞ Calculating Total (Public):', {
                        trainingType,
                        costPerPerson,
                        participantCount,
                        source: 'employeeManager.employees.length',
                        total: total.toFixed(2)
                    });

                } else if (trainingType === 'In House') {
                    // ========================================
                    // üìå In House: ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏Ñ‡∏π‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô)
                    // User ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                    // ========================================
                    const registrationCost = parseFloat(document.getElementById('RegistrationCost')?.value || 0);
                    const instructorFee = parseFloat(document.getElementById('InstructorFee')?.value || 0);
                    const instructorCommission = parseFloat(document.getElementById('InstructorCommission')?.value || 0);
                    const equipmentCost = parseFloat(document.getElementById('EquipmentCost')?.value || 0);
                    const foodCost = parseFloat(document.getElementById('FoodCost')?.value || 0);
                    const otherCost = parseFloat(document.getElementById('OtherCost')?.value || 0);

                    // ‚úÖ In House ‡πÅ‡∏Ñ‡πà‡∏£‡∏ß‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏π‡∏ì
                    total = registrationCost + instructorFee + instructorCommission +
                            equipmentCost + foodCost + otherCost;

                    console.log('üí∞ Calculating Total (In House):', {
                        trainingType,
                        registrationCost,
                        instructorFee,
                        instructorCommission,
                        equipmentCost,
                        foodCost,
                        otherCost,
                        total: total.toFixed(2)
                    });
                }

                // ========================================
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                // ========================================
                if (trainingType === 'Public') {
                    const displayPublic = document.getElementById('totalCostDisplayPublic');
                    if (displayPublic) {
                        displayPublic.textContent = total.toLocaleString('th-TH', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                } else if (trainingType === 'In House') {
                    const displayInHouse = document.getElementById('totalCostDisplay');
                    if (displayInHouse) {
                        displayInHouse.textContent = total.toLocaleString('th-TH', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Hidden Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
                const inputElement = document.getElementById('totalCostInput');
                if (inputElement) {
                    inputElement.value = total.toFixed(2);
                }

                return total;

            } catch (error) {
                console.error('‚ùå Error calculating total cost:', error);
                return 0;
            }
        }

        // ====================================================================
        // üîß ‡∏ú‡∏π‡∏Å Event Listeners ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å Input
        // ====================================================================
        function initializeBudgetCalculation() {
            console.log('üîß Initializing budget calculation...');

            // ====================================================================
            // üîÑ Auto-clear ‡∏Ñ‡πà‡∏≤ 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Focus ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Blur
            // ====================================================================
            const autoClearInputs = document.querySelectorAll('.budget-input, .budget-input-public, .budget-input-inhouse');

            autoClearInputs.forEach(input => {
                // Clear ‡∏Ñ‡πà‡∏≤ 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Focus
                input.addEventListener('focus', function() {
                    if (this.value === '0' || this.value === '0.00') {
                        this.value = '';
                    }
                });

                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Blur ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
                input.addEventListener('blur', function() {
                    if (this.value.trim() === '') {
                        this.value = '0';
                    }
                });
            });

            console.log(`‚úÖ Auto-clear setup for ${autoClearInputs.length} inputs`);

            // ====================================================================
            // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Input ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (In House + Public)
            // ====================================================================
            const budgetInputIds = [
                // In House Fields
                'RegistrationCost',
                'InstructorFee',
                'InstructorCommission',
                'EquipmentCost',
                'FoodCost',
                'OtherCost',
                // Public Fields
                'CostPerPerson',
                'TrainingHours'
            ];

            let foundCount = 0;
            let notFoundInputs = [];

            budgetInputIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    foundCount++;
                    console.log(`‚úÖ Found & Bound: ${id}`);
                    // ‡∏ú‡∏π‡∏Å Event Listeners ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö
                    ['input', 'change', 'keyup', 'blur'].forEach(eventType => {
                        input.addEventListener(eventType, calculateTotalCost);
                    });
                } else {
                    notFoundInputs.push(id);
                    console.warn(`‚ö†Ô∏è Input not found: ${id}`);
                }
            });

            // ‚≠ê ‡∏ú‡∏π‡∏Å Event Listener ‡∏Å‡∏±‡∏ö Training Type Radio Buttons
            const trainingTypeRadios = document.querySelectorAll('input[name="TrainingType"]');
            trainingTypeRadios.forEach(radio => {
                radio.addEventListener('change', resetUnusedFields);
                console.log(`‚úÖ Bound Training Type: ${radio.value}`);
            });

            // ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å
            console.log(`üìä Summary: ${foundCount}/${budgetInputIds.length} inputs bound`);
            console.log(`üìª Training Type radios: ${trainingTypeRadios.length} bound`);

            if (notFoundInputs.length > 0) {
                console.warn(`‚ö†Ô∏è Missing inputs: ${notFoundInputs.join(', ')}`);
            }

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
            calculateTotalCost();

            console.log('‚úÖ Budget calculation initialized successfully!');
        }

        // ====================================================================
        // üöÄ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
        // ====================================================================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeBudgetCalculation);
        } else {
            initializeBudgetCalculation();
        }

        // ====================================================================
        // 0. Load Departments and Positions - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
        // ====================================================================
        // ‚úÖ REMOVED: ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö DOMContentLoaded listener ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ~2243)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô

        async function loadDepartmentsAndPositions() {
            try {
                const response = await fetch('/api/employee/departments-positions');

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        const departmentSelect = document.getElementById('departmentSelect');
                        if (departmentSelect && result.departments) {
                            result.departments.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept;
                                option.textContent = dept;
                                departmentSelect.appendChild(option);
                            });
                        }

                        const positionSelect = document.getElementById('positionSelect');
                        if (positionSelect && result.positions) {
                            result.positions.forEach(pos => {
                                const option = document.createElement('option');
                                option.value = pos;
                                option.textContent = pos;
                                positionSelect.appendChild(option);
                            });
                        }

                        console.log('‚úÖ Loaded departments:', result.departments.length);
                        console.log('‚úÖ Loaded positions:', result.positions.length);
                    } else {
                        console.error('‚ùå Failed to load departments and positions');
                    }
                } else {
                    console.error('‚ùå API Error:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Error loading departments and positions:', error);
            }
        }
       $(document).ready(function() {
        console.log('üîß Initializing Approvers Select2...');

        // 1Ô∏è‚É£ Section Manager
        $('#sectionManagerSelect').select2({
            theme: 'bootstrap-5',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Section Manager...',
            allowClear: true,
            width: '100%',
            ajax: {
                url: '/api/employees/approvers/section-manager',
                dataType: 'json',
                delay: 300,
                data: function(params) {
                    const dept = $('#departmentSelect').val();
                    const pos = $('#positionSelect').val();
                    console.log('üîç Section Manager Search:', params.term, 'Dept:', dept, 'Pos:', pos);
                    return {
                        q: params.term || '',
                        department: dept || '',
                        position: pos || ''
                    };
                },
                processResults: function(data) {
                    console.log('üìã Section Managers found:', data.length);

                    // Add SKIP option as first choice
                    var results = [{
                        id: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        text: '‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                    }];

                    // Add employee results
                    results = results.concat(data.map(item => ({
                        id: item.id,
                        text: `${item.name} (${item.email})`
                    })));

                    return { results: results };
                },
                cache: false
            },
            minimumInputLength: 0
        }).on('change', function() {
            const selectedValue = $(this).val();
            $('#sectionManagerIdHidden').val(selectedValue);
            console.log('‚úÖ Section Manager selected:', selectedValue);
        });

        // 2Ô∏è‚É£ Department Manager - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç selector
        $('#departmentManagerSelect').select2({
            theme: 'bootstrap-5',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Department Manager...',
            allowClear: true,
            width: '100%',
            ajax: {
                url: '/api/employees/approvers/dept-manager',
                dataType: 'json',
                delay: 300,
                data: function(params) {
                    const dept = $('#departmentSelect').val();
                    const pos = $('#positionSelect').val();
                    console.log('üîç Dept Manager Search:', params.term, 'Dept:', dept, 'Pos:', pos);
                    return {
                        q: params.term || '',
                        department: dept || '',
                        position: pos || ''
                    };
                },
                processResults: function(data) {
                    console.log('üìã Dept Managers found:', data.length);

                    // Add SKIP option as first choice
                    var results = [{
                        id: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        text: '‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                    }];

                    // Add employee results
                    results = results.concat(data.map(item => ({
                        id: item.id,
                        text: `${item.name} (${item.email})`
                    })));

                    return { results: results };
                },
                cache: false
            },
            minimumInputLength: 0
        }).on('change', function() {
            const selectedValue = $(this).val();
            $('#departmentManagerIdHidden').val(selectedValue);
            console.log('‚úÖ Dept Manager selected:', selectedValue);
        });

        // 3Ô∏è‚É£ Managing Director - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç selector
        $('#managingDirectorSelect').select2({
            theme: 'bootstrap-5',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Managing Director...',
            allowClear: true,
            width: '100%',
            ajax: {
                url: '/api/employees/approvers/director',
                dataType: 'json',
                delay: 300,
                data: function(params) {
                    console.log('üîç Director Search:', params.term);
                    return { q: params.term || '' };
                },
                processResults: function(data) {
                    console.log('üìã Directors found:', data.length);

                    // Add SKIP option as first choice
                    var results = [{
                        id: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        text: '‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                    }];

                    // Add employee results
                    results = results.concat(data.map(item => ({
                        id: item.id,
                        text: `${item.name} - ${item.level} (${item.email})`
                    })));

                    return { results: results };
                },
                cache: false
            },
            minimumInputLength: 0
        }).on('change', function() {
            const selectedValue = $(this).val();
            $('#managingDirectorIdHidden').val(selectedValue);
            console.log('‚úÖ Director selected:', selectedValue);
        });

        // Deputy Managing Director Select2
        $('#deputyManagingDirectorSelect').select2({
            theme: 'bootstrap-5',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Deputy Managing Director...',
            allowClear: true,
            width: '100%',
            ajax: {
                url: '/api/employees/approvers/deputy-director',
                dataType: 'json',
                delay: 300,
                data: function(params) {
                    console.log('üîç Deputy Director Search:', params.term);
                    return { q: params.term || '' };
                },
                processResults: function(data) {
                    console.log('üìã Deputy Directors found:', data.length);

                    // Add SKIP option as first choice
                    var results = [{
                        id: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        text: '‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                    }];

                    // Add employee results
                    results = results.concat(data.map(item => ({
                        id: item.id,
                        text: `${item.name} - ${item.level} (${item.email})`
                    })));

                    return { results: results };
                },
                cache: false
            },
            minimumInputLength: 0
        }).on('change', function() {
            const selectedValue = $(this).val();
            $('#deputyManagingDirectorIdHidden').val(selectedValue);
            console.log('‚úÖ Deputy Director selected:', selectedValue);
        });

        // 4Ô∏è‚É£ Reset ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Department/Position
        $('#departmentSelect, #positionSelect').on('change', function() {
            console.log('üîÑ Department/Position changed - Resetting approvers');

            // Clear Section Manager
            $('#sectionManagerSelect').val(null).trigger('change');
            $('#sectionManagerIdHidden').val('');

            // Clear Department Manager
            $('#departmentManagerSelect').val(null).trigger('change');
            $('#departmentManagerIdHidden').val('');

            console.log('‚úÖ Approvers reset completed');
        });

        console.log('‚úÖ All Approvers Select2 initialized');
    });

        // ====================================================================
        // 1. Employee Manager Class
        // ====================================================================
        // ‚ú® ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï EmployeeManager class
        class EmployeeManager {
            constructor() {
                this.employees = [];
                this.currentEmployee = null;
                this.rowCounter = 1;
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Department-based quota
                this.totalCostUsedInForm = 0;
                this.totalHoursUsedInForm = 0;
                this.departmentQuota = 0;
                this.departmentQhours = 0;
                this.departmentUsedCostExcludingThis = 0;  // ‚úÖ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ)
                this.departmentUsedHoursExcludingThis = 0;
                this.initializeEvents();
            }

            initializeEvents() {
                document.getElementById('searchEmployeeBtn').addEventListener('click', () => {
                    this.searchEmployee();
                });

                document.getElementById('employeeCode').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchEmployee();
                    }
                });

                document.getElementById('addEmployeeBtn').addEventListener('click', () => {
                    this.addEmployeeToTable();
                });

                // ‚úÖ Validate ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                document.getElementById('employeeSearchModal').addEventListener('show.bs.modal', (event) => {
                    const department = document.getElementById('departmentSelect')?.value;
                    const position = document.getElementById('positionSelect')?.value;

                    if (!department || !position) {
                        event.preventDefault();
                        alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ù‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏ú‡∏ô‡∏Å ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                        return false;
                    }
                });

                document.getElementById('employeeSearchModal').addEventListener('hidden.bs.modal', () => {
                    this.resetModal();
                });

                // ‚úÖ Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
                const recalculateBtn = document.getElementById('recalculateBtn');
                if (recalculateBtn) {
                    recalculateBtn.addEventListener('click', () => {
                        this.recalculateFromCurrentQuota();
                    });
                }
            }

            async searchEmployee() {
                const employeeCode = document.getElementById('employeeCode').value.trim();

                if (!employeeCode) {
                    this.showError('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                    return;
                }

                if (employeeCode.length !== 7) {
                    this.showError('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 7 ‡∏´‡∏•‡∏±‡∏Å');
                    return;
                }

                this.showLoading(true);
                this.hideEmployeeInfo();
                this.hideError();

                try {
                    const employee = await this.fetchEmployeeData(employeeCode);

                    if (employee) {
                        this.currentEmployee = employee;

                        // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                        if (this.departmentQuota === 0 && employee.departmentQuota > 0) {
                            this.departmentQuota = employee.departmentQuota;
                            this.departmentQhours = employee.departmentQhours;
                            this.updateDepartmentQuotaDisplay();
                        }

                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Public)
                        const trainingType = document.querySelector('input[name="TrainingType"]:checked')?.value;
                        if (trainingType?.toUpperCase() === 'PUBLIC' && this.employees.length > 0) {
                            const firstDepartment = this.employees[0].department;
                            if (employee.department !== firstDepartment) {
                                this.showError(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ!\n‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢ ${firstDepartment}`);
                                return;
                            }
                        }

                        this.displayEmployeeInfo(employee);
                        document.getElementById('addEmployeeBtn').disabled = false;
                    } else {
                        this.showError('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™: ' + employeeCode);
                    }
                } catch (error) {
                    console.error('Error searching employee:', error);
                    this.showError('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                } finally {
                    this.showLoading(false);
                }
            }

            async fetchEmployeeData(employeeCode) {
                try {
                    console.log('üîç Searching for employee:', employeeCode);

                    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Department ‡πÅ‡∏•‡∏∞ TrainingType
                    const departmentSelect = document.getElementById('departmentSelect');
                    const department = departmentSelect ? departmentSelect.value : '';
                    const trainingType = document.querySelector('input[name="TrainingType"]:checked')?.value || '';

                    console.log('üè¢ Department:', department);
                    console.log('üéì Training Type:', trainingType);

                    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏û‡∏£‡πâ‡∏≠‡∏° query parameters
                    let url = `/api/employee/search/${employeeCode}`;
                    const params = new URLSearchParams();

                    if (department && trainingType) {
                        params.append('department', department);
                        params.append('trainingType', trainingType);
                    }

                    if (params.toString()) {
                        url += `?${params.toString()}`;
                    }

                    console.log('üîó Request URL:', url);

                    const response = await fetch(url);

                    console.log('üì° Response status:', response.status);

                    if (!response.ok) {
                        console.error('‚ùå Response not OK:', response.status);

                        try {
                            const errorData = await response.json();
                            console.error('‚ùå Error data:', errorData);
                            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á error message ‡∏à‡∏≤‡∏Å backend
                            if (errorData.message) {
                                alert(errorData.message);
                            }
                        } catch {
                            console.error('‚ùå Could not parse error as JSON');
                        }

                        return null;
                    }

                    const result = await response.json();
                    console.log('‚úÖ API Response:', result);
                    console.log('üìä API Response (JSON):', JSON.stringify(result, null, 2));

                    console.log('üîç result.success:', result.success);
                    console.log('üîç result.employee:', result.employee);
                    console.log('üîç Has employee?', !!result.employee);

                    if (result.success && result.employee) {
                        if (result.warningMessage) {
                            this.showWarning(result.warningMessage);
                        }

                        return {
                            empCode: result.employee.empCode,
                            prefix: result.employee.prefix,
                            name: result.employee.name,
                            lastname: result.employee.lastname,
                            position: result.employee.position,
                            level: result.employee.level,
                            department: result.employee.department,
                            company: result.employee.company,
                            email: result.employee.email,
                            currentYearHours: result.employee.currentYearHours || 0,
                            currentYearCost: result.employee.currentYearCost || 0,
                            thisTimeHours: result.employee.thisTimeHours || 0,
                            thisTimeCost: result.employee.thisTimeCost || 0,
                            remainingHours: result.employee.remainingHours ?? 0,
                            remainingCost: result.employee.remainingCost ?? 0,
                            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢
                            departmentQuota: result.employee.departmentQuota || 0,
                            departmentQhours: result.employee.departmentQhours || 0,
                            pendingRequestCount: result.employee.pendingRequestCount || 0,
                            pendingHours: result.employee.pendingHours || 0,
                            pendingCost: result.employee.pendingCost || 0
                        };
                    } else {
                        console.error('‚ùå API returned success=false or no employee data');
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå Error fetching employee:', error);
                    throw error;
                }
            }

            displayEmployeeInfo(employee) {
                document.getElementById('displayEmpCode').textContent = employee.empCode;
                document.getElementById('displayFullName').textContent =
                    `${employee.prefix}${employee.name} ${employee.lastname}`;
                document.getElementById('displayPosition').textContent = employee.position;
                document.getElementById('displayLevel').textContent = employee.level;

                this.showEmployeeInfo();
            }

                addEmployeeToTable() {
            if (!this.currentEmployee) return;

            if (this.employees.some(emp => emp.empCode === this.currentEmployee.empCode)) {
                this.showError('‚ùå ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            // ‚≠ê ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const trainingHoursInput = document.getElementById('TrainingHours');
            const costPerPersonInput = document.getElementById('CostPerPerson');

            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
            const trainingHours = trainingHoursInput ? parseFloat(trainingHoursInput.value) || 0 : 0;
            const costPerPerson = costPerPersonInput ? parseFloat(costPerPersonInput.value) || 0 : 0;

            console.log('üìä Training Hours from form:', trainingHours);
            console.log('üí∞ Cost Per Person from form:', costPerPerson);

            // ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô currentEmployee
            this.currentEmployee.thisTimeHours = trainingHours;
            this.currentEmployee.thisTimeCost = costPerPerson;

            // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö Department-based (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public)
            const trainingType = document.querySelector('input[name="TrainingType"]:checked')?.value;
            if (trainingType?.toUpperCase() === 'PUBLIC') {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡∏ù‡πà‡∏≤‡∏¢
                this.currentEmployee.remainingHours = this.departmentQhours -
                    (this.currentEmployee.currentYearHours + this.totalHoursUsedInForm + trainingHours);
                this.currentEmployee.remainingCost = this.departmentQuota -
                    (this.currentEmployee.currentYearCost + this.totalCostUsedInForm + costPerPerson);

                // ‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                this.totalHoursUsedInForm += trainingHours;
                this.totalCostUsedInForm += costPerPerson;
            } else {
                // In House ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° (Individual)
                this.currentEmployee.remainingHours = 12 - (this.currentEmployee.currentYearHours + trainingHours);
                this.currentEmployee.remainingCost = 10000 - (this.currentEmployee.currentYearCost + costPerPerson);
            }

            console.log('‚úÖ Updated employee:', {
                empCode: this.currentEmployee.empCode,
                thisTimeHours: this.currentEmployee.thisTimeHours,
                thisTimeCost: this.currentEmployee.thisTimeCost,
                departmentQuota: this.departmentQuota,
                departmentQhours: this.departmentQhours,
                totalCostUsedInForm: this.totalCostUsedInForm,
                totalHoursUsedInForm: this.totalHoursUsedInForm,
                remainingHours: this.currentEmployee.remainingHours,
                remainingCost: this.currentEmployee.remainingCost
            });

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á array
            this.employees.push(this.currentEmployee);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const row = this.createEmployeeRow(this.currentEmployee, this.rowCounter);
            document.getElementById('employeeTableBody').appendChild(row);

            this.rowCounter++;

            // ‡∏õ‡∏¥‡∏î modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('employeeSearchModal'));
            modal.hide();

            // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô)
            // ‡πÉ‡∏ä‡πâ trainingType ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2024)
            if (trainingType?.toUpperCase() === 'PUBLIC') {
                if (typeof calculateTotalBudgetPublic === 'function') {
                    calculateTotalBudgetPublic();
                }
                // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ParticipantCount field
                this.updateParticipantCount();
            }

            this.showSuccessToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }

            createEmployeeRow(employee, rowNumber) {
                const row = document.createElement('tr');
                row.className = 'table-light employee-row';
                row.dataset.empCode = employee.empCode;

                const trainingData = {
                    currentYearHours: employee.currentYearHours || 0,
                    currentYearCost: employee.currentYearCost || 0,
                    thisTimeHours: employee.thisTimeHours || 0,
                    thisTimeCost: employee.thisTimeCost || 0
                };

                const remainingHours = employee.remainingHours ?? 0;
                const remainingCost = employee.remainingCost ?? 0;

                const hoursColorClass = remainingHours >= 0 ? '#e8f5e8' : '#ffebee';
                const hoursTextClass = remainingHours >= 0 ? 'bg-success' : 'bg-danger';
                const costColorClass = remainingCost >= 0 ? '#e8f5e8' : '#ffebee';
                const costTextClass = remainingCost >= 0 ? 'bg-success' : 'bg-danger';

                row.innerHTML = `
                    <td class="text-center py-3 fw-bold border-2" style="background-color: #f8f9fa;">
                        <span class="badge bg-primary px-3 py-2">${rowNumber}</span>
                    </td>
                    <td class="text-center py-3 fw-semibold border-2">
                        <span class="badge bg-light text-dark px-3 py-2">${employee.empCode}</span>
                    </td>
                    <td class="text-center py-3 fw-semibold border-2">
                        ${employee.prefix}${employee.name} ${employee.lastname}
                    </td>
                    <td class="text-center py-3 fw-medium border-2">
                        <span class="badge bg-info text-white px-3 py-2">${employee.level || '-'}</span>
                    </td>
                    <td class="text-center py-3 fw-bold border-2" style="background-color: #e3f2fd; color: #1976d2; font-size: 1.1rem;">
                        ${trainingData.currentYearHours}
                    </td>
                    <td class="text-center py-3 fw-bold border-2" style="background-color: #e3f2fd; color: #1976d2; font-size: 1.1rem;">
                        ${trainingData.currentYearCost.toLocaleString()}
                    </td>
                    <td class="text-center py-3 fw-bold border-2" style="background-color: #f3e5f5; color: #7b1fa2; font-size: 1.1rem;">
                        ${trainingData.thisTimeHours}
                    </td>
                    <td class="text-center py-3 fw-bold border-2" style="background-color: #f3e5f5; color: #7b1fa2; font-size: 1.1rem;">
                        ${trainingData.thisTimeCost.toLocaleString()}
                    </td>
                    <td class="text-center py-3 fw-bold border-2" style="background-color: ${hoursColorClass};">
                        <span class="badge ${hoursTextClass} text-white px-3 py-2" style="font-size: 1rem;">
                            ${remainingHours}
                        </span>
                    </td>
                    <td class="text-center py-3 fw-bold border-2" style="background-color: ${costColorClass};">
                        <span class="badge ${costTextClass} text-white px-3 py-2" style="font-size: 1rem;">
                            ${remainingCost.toLocaleString()}
                        </span>
                    </td>
                    <td class="text-center py-3 border-2" style="background-color: #f0f8ff;">
                        <i class="fas fa-check-circle text-success" style="font-size: 1.5rem;"></i>
                    </td>
                    <td class="text-center py-3 border-2">
                        <input type="text" class="form-control form-control-sm note-input" data-emp-code="${employee.empCode}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" style="border-radius: 8px;">
                    </td>
                    <td class="text-center py-3 border-2">
                        <button type="button" class="btn btn-sm btn-danger" onclick="employeeManager.removeEmployee('${employee.empCode}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                return row;
            }

            removeEmployee(empCode) {
                if (confirm('‚ùì ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    // ‚úÖ ‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Public)
                    const trainingType = document.querySelector('input[name="TrainingType"]:checked')?.value;
                    if (trainingType?.toUpperCase() === 'PUBLIC') {
                        const employeeToRemove = this.employees.find(emp => emp.empCode === empCode);
                        if (employeeToRemove) {
                            this.totalCostUsedInForm -= employeeToRemove.thisTimeCost || 0;
                            this.totalHoursUsedInForm -= employeeToRemove.thisTimeHours || 0;
                            console.log('‚úÖ Reduced quota:', {
                                totalCostUsedInForm: this.totalCostUsedInForm,
                                totalHoursUsedInForm: this.totalHoursUsedInForm
                            });
                        }
                    }

                    this.employees = this.employees.filter(emp => emp.empCode !== empCode);

                    const row = document.querySelector(`tr[data-emp-code="${empCode}"]`);
                    if (row) {
                        row.remove();
                    }

                    this.updateRowNumbers();

                    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Public)
                    if (trainingType?.toUpperCase() === 'PUBLIC') {
                        this.recalculateAllRemainingQuota();
                        // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏•‡∏î‡∏•‡∏á)
                        if (typeof calculateTotalBudgetPublic === 'function') {
                            calculateTotalBudgetPublic();
                        }
                        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ParticipantCount field
                        this.updateParticipantCount();
                    }

                    this.showSuccessToast('‚úÖ ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
            }

            // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ParticipantCount field (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public Training)
            updateParticipantCount() {
                const participantCountField = document.getElementById('ParticipantCount');
                if (participantCountField) {
                    const count = this.employees.length;
                    participantCountField.value = count.toString();
                    console.log(`‚úÖ Updated ParticipantCount field: ${count} people`);
                }
            }

            // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            recalculateAllRemainingQuota() {
                const trainingType = document.querySelector('input[name="TrainingType"]:checked')?.value;
                let accumulatedCost = 0;
                let accumulatedHours = 0;

                this.employees.forEach((emp, index) => {
                    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
                    if (trainingType?.toUpperCase() === 'PUBLIC') {
                        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public: ‡πÉ‡∏ä‡πâ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ)
                        emp.remainingCost = this.departmentQuota -
                            this.departmentUsedCostExcludingThis - accumulatedCost - emp.thisTimeCost;
                        emp.remainingHours = this.departmentQhours -
                            this.departmentUsedHoursExcludingThis - accumulatedHours - emp.thisTimeHours;
                    } else {
                        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö In House: ‡πÉ‡∏ä‡πâ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÜ‡∏ô‡∏±‡πâ‡∏ô
                        emp.remainingCost = this.departmentQuota -
                            emp.currentYearCost - accumulatedCost - emp.thisTimeCost;
                        emp.remainingHours = this.departmentQhours -
                            emp.currentYearHours - accumulatedHours - emp.thisTimeHours;
                    }

                    // ‡∏ö‡∏ß‡∏Å‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°
                    accumulatedCost += emp.thisTimeCost;
                    accumulatedHours += emp.thisTimeHours;

                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    this.updateEmployeeRowDisplay(emp);
                });

                console.log('‚úÖ Recalculated all remaining quotas', {
                    trainingType,
                    departmentUsed: this.departmentUsedCostExcludingThis,
                    accumulatedCost
                });
            }

            // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            updateEmployeeRowDisplay(emp) {
                const row = document.querySelector(`tr[data-emp-code="${emp.empCode}"]`);
                if (!row) return;

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï remaining hours cell
                const hoursCells = row.querySelectorAll('td');
                if (hoursCells.length > 8) {
                    const hoursCell = hoursCells[8];
                    const hoursColorClass = emp.remainingHours >= 0 ? '#e8f5e8' : '#ffebee';
                    const hoursTextClass = emp.remainingHours >= 0 ? 'bg-success' : 'bg-danger';
                    hoursCell.style.backgroundColor = hoursColorClass;
                    hoursCell.innerHTML = `
                        <span class="badge ${hoursTextClass} text-white px-3 py-2" style="font-size: 1rem;">
                            ${emp.remainingHours.toLocaleString()}
                        </span>
                    `;
                }

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï remaining cost cell
                if (hoursCells.length > 9) {
                    const costCell = hoursCells[9];
                    const costColorClass = emp.remainingCost >= 0 ? '#e8f5e8' : '#ffebee';
                    const costTextClass = emp.remainingCost >= 0 ? 'bg-success' : 'bg-danger';
                    costCell.style.backgroundColor = costColorClass;
                    costCell.innerHTML = `
                        <span class="badge ${costTextClass} text-white px-3 py-2" style="font-size: 1rem;">
                            ${emp.remainingCost.toLocaleString()}
                        </span>
                    `;
                }
            }

            updateRowNumbers() {
                const rows = document.querySelectorAll('#employeeTableBody tr');
                rows.forEach((row, index) => {
                    const numberCell = row.querySelector('.badge.bg-primary');
                    if (numberCell) {
                        numberCell.textContent = index + 1;
                    }
                });
                this.rowCounter = rows.length + 1;
            }

            showWarning(message) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning mt-3';
                warningDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;

                const infoSection = document.getElementById('employeeInfoSection');
                infoSection.appendChild(warningDiv);
            }

            showLoading(show) {
                document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            }

            showEmployeeInfo() {
                document.getElementById('employeeInfoSection').style.display = 'block';
            }

            hideEmployeeInfo() {
                document.getElementById('employeeInfoSection').style.display = 'none';
                document.getElementById('addEmployeeBtn').disabled = true;
            }

            showError(message) {
                document.getElementById('errorText').textContent = message;
                document.getElementById('errorMessage').style.display = 'block';
            }

            hideError() {
                document.getElementById('errorMessage').style.display = 'none';
            }

            resetModal() {
                document.getElementById('employeeCode').value = '';
                this.hideEmployeeInfo();
                this.hideError();
                this.showLoading(false);
                this.currentEmployee = null;
            }

            showSuccessToast(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-4 alert alert-success alert-dismissible fade show';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° function ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢
    updateDepartmentQuotaDisplay() {
        const quotaText = document.getElementById('departmentQuotaText');
        const qhoursText = document.getElementById('departmentQhoursText');

        if (quotaText && this.departmentQuota > 0) {
            quotaText.textContent = `(‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ ${this.departmentQuota.toLocaleString()} ‡∏ö./‡∏õ‡∏µ)`;
        }

        if (qhoursText && this.departmentQhours > 0) {
            qhoursText.textContent = `(‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ ${this.departmentQhours.toLocaleString()} ‡∏ä‡∏°./‡∏õ‡∏µ)`;
        }

        console.log('‚úÖ Updated quota display:', {
            departmentQuota: this.departmentQuota,
            departmentQhours: this.departmentQhours
        });
    }

    getEmployeesData() {  // ‚úÖ ‡∏ñ‡∏π‡∏Å - ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô class
        console.log('üìä Getting employees data...');
        console.log('   Total employees:', this.employees.length);

        if (!this.employees || this.employees.length === 0) {
            console.warn('‚ö†Ô∏è No employees in list');
            return [];
        }

        const employeesData = this.employees.map((emp, index) => {
            console.log(`   Employee ${index + 1}:`, emp.empCode);
                 // ‚≠ê ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                const noteInput = document.querySelector(`input.note-input[data-emp-code="${emp.empCode}"]`);
                const notes = noteInput ? noteInput.value.trim() : '';
                     console.log(`     Notes for ${emp.empCode}:`, notes || '(empty)');

            return {
                empCode: emp.empCode || '',
                fullName: `${emp.prefix || ''}${emp.name || ''} ${emp.lastname || ''}`.trim(),
                position: emp.position || '',
                level: emp.level || '',
                department: emp.department || '',
                currentYearHours: emp.currentYearHours || 0,
                currentYearCost: emp.currentYearCost || 0,
                thisTimeHours: emp.thisTimeHours || 0,
                thisTimeCost: emp.thisTimeCost || 0,
                remainingHours: emp.remainingHours || 0,      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
                remainingCost: emp.remainingCost || 0,        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
                notes: notes
            };
        });

        console.log('‚úÖ Employees data prepared:', employeesData);
        return employeesData;
    }

    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    async recalculateFromCurrentQuota() {
        console.log('üîÑ Starting recalculation from current quota...');

        const trainingType = '@Model.TrainingType'?.toUpperCase();
        const department = '@Html.Raw(Model.Department)';

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô IN HOUSE ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
        if (trainingType !== 'PUBLIC') {
            alert('‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö PUBLIC training ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            return;
        }

        if (!department) {
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ');
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!this.employees || this.employees.length === 0) {
            alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ');
            return;
        }

        try {
            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å API (‡πÉ‡∏ä‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å)
            const firstEmployee = this.employees[0];
            console.log('üì° Fetching current quota for department:', department);
            console.log('   Using employee:', firstEmployee.empCode);

            const url = `/api/employee/search/${firstEmployee.empCode}?department=${encodeURIComponent(department)}&trainingType=${trainingType}`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`API returned ${response.status}`);
            }

            const data = await response.json();

            if (!data.success || !data.employee) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ');
                return;
            }

            const currentDepartmentQuota = data.employee.departmentQuota || 0;
            const currentDepartmentQhours = data.employee.departmentQhours || 0;
            const currentYearCost = data.employee.currentYearCost || 0;
            const currentYearHours = data.employee.currentYearHours || 0;

            console.log('‚úÖ Current quota fetched:', {
                quota: currentDepartmentQuota,
                hours: currentDepartmentQhours,
                usedCost: currentYearCost,
                usedHours: currentYearHours
            });

            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô currentYearCost ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const currentStatus = '@Model.Status'.toUpperCase();
            const approvedStatuses = ['APPROVED', 'RESCHEDULED', 'COMPLETE'];
            const isApproved = approvedStatuses.includes(currentStatus);

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì departmentUsedCostExcludingThis
            let departmentUsedCostExcludingThis = currentYearCost;
            let departmentUsedHoursExcludingThis = currentYearHours;

            if (isApproved && this.totalCostUsedInForm > 0) {
                departmentUsedCostExcludingThis = currentYearCost - this.totalCostUsedInForm;
                departmentUsedHoursExcludingThis = currentYearHours - this.totalHoursUsedInForm;
            }

            console.log('üìä Department used (excluding this form):', {
                cost: departmentUsedCostExcludingThis,
                hours: departmentUsedHoursExcludingThis
            });

            // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (accumulated pattern)
            let accumulatedCost = 0;
            let accumulatedHours = 0;

            this.employees.forEach((emp, index) => {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (accumulated)
                const remainingCost = currentDepartmentQuota - departmentUsedCostExcludingThis - accumulatedCost - emp.thisTimeCost;
                const remainingHours = currentDepartmentQhours - departmentUsedHoursExcludingThis - accumulatedHours - emp.thisTimeHours;

                console.log(`Employee ${index + 1} (${emp.empCode}):`, {
                    thisTimeCost: emp.thisTimeCost,
                    thisTimeHours: emp.thisTimeHours,
                    accumulatedCost,
                    accumulatedHours,
                    remainingCost,
                    remainingHours
                });

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô employee object
                emp.remainingCost = remainingCost;
                emp.remainingHours = remainingHours;

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                const rows = document.querySelectorAll('#employeeTableBody tr');
                if (rows[index]) {
                    const cells = rows[index].querySelectorAll('td');
                    if (cells.length >= 10) {
                        // Column 9: Remaining Hours
                        cells[8].textContent = remainingHours.toLocaleString();
                        // Column 10: Remaining Cost
                        cells[9].textContent = remainingCost.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡∏ö
                        cells[8].style.color = remainingHours < 0 ? 'red' : '';
                        cells[9].style.color = remainingCost < 0 ? 'red' : '';
                    }
                }

                // ‡∏™‡∏∞‡∏™‡∏°‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                accumulatedCost += emp.thisTimeCost;
                accumulatedHours += emp.thisTimeHours;
            });

            // 4. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
            this.departmentQuota = currentDepartmentQuota;
            this.departmentQhours = currentDepartmentQhours;
            this.updateDepartmentQuotaDisplay();

            // 5. ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            const warningContainer = document.getElementById('outdatedWarningContainer');
            if (warningContainer) {
                warningContainer.style.display = 'none';
            }

            // 6. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            this.showSuccessToast('‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

            console.log('‚úÖ Recalculation completed successfully!');

        } catch (error) {
            console.error('‚ùå Error during recalculation:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà: ' + error.message);
        }
    }
        }

        // ‚≠ê Initialize - ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å class
        const employeeManager = new EmployeeManager();
        console.log('‚úÖ EmployeeManager initialized');


      // ===============================================
    // üîπ Cascade Dropdown: Department ‚Üí Position
    // ===============================================

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Departments ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Page loaded!');

        // ‚úÖ 1. ‡πÇ‡∏´‡∏•‡∏î Departments options
        await loadDepartments();

        // ‚úÖ 2. Bind event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Department ‚Üí Position cascading
        //    (‡∏ï‡πâ‡∏≠‡∏á bind ‡∏Å‡πà‡∏≠‡∏ô setDepartmentAndPosition() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ event ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)
        bindDepartmentPositionListeners();

        // ‚úÖ 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å Model (pre-populate)
        await loadExistingData();

        // ‚úÖ 4. Initialize budget calculation
        setTimeout(() => {
            initializeBudgetCalculation();
        }, 100);

        console.log('‚úÖ Page initialization completed');
    });

    // ===============================================
    // üîπ Load Existing Data from Model (for Edit mode)
    // ===============================================
    async function loadExistingData() {
        console.log('üîÑ Loading existing data from Model...');

        // ‚úÖ Set flag ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô reset approvers ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
        isLoadingExistingData = true;

        try {
            // 1. Load Employees from Model
            await loadExistingEmployees();

            // 2. Set Department and Position values
            await setDepartmentAndPosition();

            // 3. Set CCEmail values
            await setCCEmail();

            // 4. Set Approvers values
            await setApprovers();

            console.log('‚úÖ Existing data loaded');
        } finally {
            // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï flag ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
            isLoadingExistingData = false;
            console.log('‚úÖ Pre-populate completed, event listeners now active');
        }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Model.Employees
    async function loadExistingEmployees() {
        const employees = @Html.Raw(Json.Serialize(Model.Employees));

        console.log('üîç Raw employees data from Model:', employees);

        if (employees && employees.length > 0) {
            console.log(`üìä Loading ${employees.length} existing employees`);

            // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å database ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà)
            const trainingType = '@Model.TrainingType';

            // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ
            let accumulatedCost = 0;
            let accumulatedHours = 0;

            employees.forEach((emp, index) => {
                console.log(`Employee ${index + 1}:`, emp);
                // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô prefix, name, lastname (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ)
                const fullName = emp.employeeName || '';  // ‚Üê camelCase
                const nameParts = fullName.split(' ');

                let prefix = '';
                let name = '';
                let lastname = '';

                if (nameParts.length === 1) {
                    name = nameParts[0];
                } else if (nameParts.length === 2) {
                    name = nameParts[0];
                    lastname = nameParts[1];
                } else if (nameParts.length >= 3) {
                    prefix = nameParts[0];
                    name = nameParts.slice(1, -1).join(' ');
                    lastname = nameParts[nameParts.length - 1];
                }

                // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å database (‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
                const remainingHours = emp.remainingHours || 0;
                const remainingCost = emp.remainingCost || 0;

                console.log(`Employee ${index + 1} (${emp.employeeCode}): Loaded remaining from DB - Hours: ${remainingHours}, Cost: ${remainingCost}`);

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á employee object ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà EmployeeManager ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                const employeeData = {
                    empCode: emp.employeeCode || '',  // ‚Üê camelCase
                    prefix: prefix,
                    name: name,
                    lastname: lastname,
                    position: emp.position || '',  // ‚Üê camelCase
                    level: emp.level || '',  // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                    department: emp.department || '',  // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                    currentYearHours: emp.previousTrainingHours || 0,  // ‚Üê camelCase
                    currentYearCost: emp.previousTrainingCost || 0,  // ‚Üê camelCase
                    thisTimeHours: emp.currentTrainingHours || 0,  // ‚Üê camelCase
                    thisTimeCost: emp.currentTrainingCost || 0,  // ‚Üê camelCase
                    remainingHours: remainingHours,
                    remainingCost: remainingCost,
                    notes: emp.notes || ''  // ‚Üê camelCase
                };

                console.log('‚úÖ Employee data created:', employeeData);

                // ‚úÖ ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PUBLIC training
                if (trainingType?.toUpperCase() === 'PUBLIC') {
                    accumulatedCost += employeeData.thisTimeCost;
                    accumulatedHours += employeeData.thisTimeHours;
                }

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° employee ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô array ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                employeeManager.employees.push(employeeData);

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á row ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                const row = employeeManager.createEmployeeRow(employeeData, employeeManager.rowCounter);
                document.getElementById('employeeTableBody').appendChild(row);

                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ notes ‡πÉ‡∏´‡πâ set ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô input
                if (emp.notes) {
                    setTimeout(() => {
                        const noteInput = document.querySelector(`input.note-input[data-emp-code="${employeeData.empCode}"]`);
                        if (noteInput) {
                            noteInput.value = emp.notes;
                        }
                    }, 100);
                }

                employeeManager.rowCounter++;
            });

            // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            if (trainingType?.toUpperCase() === 'PUBLIC') {
                employeeManager.totalCostUsedInForm = accumulatedCost;
                employeeManager.totalHoursUsedInForm = accumulatedHours;
            }

            console.log('‚úÖ Employees loaded:', employees.length);
            console.log('‚úÖ Accumulated totals:', {
                totalCost: employeeManager.totalCostUsedInForm,
                totalHours: employeeManager.totalHoursUsedInForm
            });

            // ‚úÖ ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å API (‡πÉ‡∏ä‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å)
            await loadDepartmentQuota(employees[0]);
        } else {
            console.log('‚ÑπÔ∏è No existing employees');
        }
    }

    // ‚úÖ ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å API
    async function loadDepartmentQuota(firstEmployee) {
        try {
            const department = '@Html.Raw(Model.Department)';
            const trainingType = '@Model.TrainingType';
            const employeeCode = firstEmployee.employeeCode;

            console.log('üîç Fetching department quota...');
            console.log('   Employee Code:', employeeCode);
            console.log('   Department:', department);
            console.log('   Training Type:', trainingType);

            const url = `/api/employee/search/${employeeCode}?department=${encodeURIComponent(department)}&trainingType=${encodeURIComponent(trainingType)}`;
            const response = await fetch(url);

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.employee) {
                    employeeManager.departmentQuota = data.employee.departmentQuota || 0;
                    employeeManager.departmentQhours = data.employee.departmentQhours || 0;
                    employeeManager.updateDepartmentQuotaDisplay();

                    console.log('‚úÖ Department quota loaded:', {
                        departmentQuota: employeeManager.departmentQuota,
                        departmentQhours: employeeManager.departmentQhours
                    });
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading department quota:', error);
        }
    }

    // Set Department ‡πÅ‡∏•‡∏∞ Position dropdown
    async function setDepartmentAndPosition() {
        const department = '@Html.Raw(Model.Department)';
        const position = '@Html.Raw(Model.Position)';

        if (department) {
            console.log('üîß Setting Department:', department);

            const departmentSelect = document.getElementById('departmentSelect');
            if (departmentSelect) {
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ option ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const departmentOption = Array.from(departmentSelect.options).find(opt => opt.value === department);
                if (!departmentOption) {
                    console.warn('‚ö†Ô∏è Department option not found:', department);
                    return;
                }

                departmentSelect.value = department;
                console.log('‚úÖ Department set:', department);

                // ‚úÖ Trigger change event to load positions
                const changeEvent = new Event('change');
                departmentSelect.dispatchEvent(changeEvent);

                // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î positions ‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏£‡∏≠‡∏à‡∏≤‡∏Å event listener)
                if (position) {
                    // ‡∏£‡∏≠ positions ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏î‡πâ‡∏ß‡∏¢ Promise
                    await new Promise(resolve => {
                        let attempts = 0;
                        const checkInterval = setInterval(() => {
                            const positionSelect = document.getElementById('positionSelect');
                            const hasOptions = positionSelect && positionSelect.options.length > 1; // ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏Ñ‡∏∑‡∏≠‡∏°‡∏µ options ‡πÅ‡∏•‡πâ‡∏ß

                            if (hasOptions || attempts > 20) { // ‡∏£‡∏≠‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (20 x 100ms)
                                clearInterval(checkInterval);
                                if (hasOptions) {
                                    positionSelect.value = position;
                                    console.log('‚úÖ Position set:', position);
                                } else {
                                    console.warn('‚ö†Ô∏è Positions not loaded in time');
                                }
                                resolve();
                            }
                            attempts++;
                        }, 100);
                    });
                }
            }
        }
    }

    // Set CCEmail dropdown
    async function setCCEmail() {
        const ccEmail = '@Html.Raw(Model.CCEmail)';

        if (ccEmail) {
            console.log('üîß Setting CCEmail:', ccEmail);

            // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ Select2 initialize ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
            await new Promise(resolve => {
                let attempts = 0;
                const checkInterval = setInterval(() => {
                    const $select = $('#ccEmailSelect');
                    const isSelect2Initialized = $select.data('select2') !== undefined;

                    if (isSelect2Initialized || attempts > 30) { // ‡∏£‡∏≠‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                        clearInterval(checkInterval);

                        if (isSelect2Initialized) {
                            // ‡πÅ‡∏¢‡∏Å email ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á comma ‡πÅ‡∏•‡∏∞ semicolon
                            const emails = ccEmail.split(/[,;]/).map(e => e.trim()).filter(e => e);
                            console.log('üìß Parsed emails:', emails);

                            if (emails.length > 0) {
                                emails.forEach(email => {
                                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á option ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                                    if ($select.find(`option[value="${email}"]`).length === 0) {
                                        const newOption = new Option(email, email, true, true);
                                        $select.append(newOption);
                                    }
                                });

                                // Select the emails
                                $select.val(emails).trigger('change');
                                console.log('‚úÖ CCEmail set:', emails);
                            }
                        } else {
                            console.warn('‚ö†Ô∏è CCEmail Select2 not initialized in time');
                        }
                        resolve();
                    }
                    attempts++;
                }, 100);
            });
        }
    }

    // Set Approvers dropdown
    async function setApprovers() {
        const sectionManagerId = '@Html.Raw(Model.SectionManagerId)';
        const departmentManagerId = '@Html.Raw(Model.DepartmentManagerId)';
        const managingDirectorId = '@Html.Raw(Model.ManagingDirectorId)';
        const deputyManagingDirectorId = '@Html.Raw(Model.DeputyManagingDirectorId)';

        // ‚≠ê Constant ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SKIP (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö backend)
        const SKIP_APPROVER = '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
        const SKIP_TEXT = '‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';

        console.log('üîß Setting Approvers...');

        // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ Select2 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î initialize ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
        await new Promise(resolve => {
            let attempts = 0;
            const checkInterval = setInterval(() => {
                const isSection = $('#sectionManagerSelect').data('select2') !== undefined;
                const isDept = $('#departmentManagerSelect').data('select2') !== undefined;
                const isDirector = $('#managingDirectorSelect').data('select2') !== undefined;
                const isDeputy = $('#deputyManagingDirectorSelect').data('select2') !== undefined;
                const allReady = isSection && isDept && isDirector && isDeputy;

                if (allReady || attempts > 30) { // ‡∏£‡∏≠‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    clearInterval(checkInterval);

                    if (allReady) {
                        // Set Section Manager
                        if (sectionManagerId) {
                            $('#sectionManagerIdHidden').val(sectionManagerId);
                            const $select = $('#sectionManagerSelect');
                            if ($select.find(`option[value="${sectionManagerId}"]`).length === 0) {
                                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô SKIP ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                                const displayText = (sectionManagerId === SKIP_APPROVER) ? SKIP_TEXT : sectionManagerId;
                                const newOption = new Option(displayText, sectionManagerId, true, true);
                                $select.append(newOption).trigger('change');
                            } else {
                                $select.val(sectionManagerId).trigger('change');
                            }
                            console.log('‚úÖ SectionManager set:', sectionManagerId);
                        }

                        // Set Department Manager
                        if (departmentManagerId) {
                            $('#departmentManagerIdHidden').val(departmentManagerId);
                            const $select = $('#departmentManagerSelect');
                            if ($select.find(`option[value="${departmentManagerId}"]`).length === 0) {
                                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô SKIP ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                                const displayText = (departmentManagerId === SKIP_APPROVER) ? SKIP_TEXT : departmentManagerId;
                                const newOption = new Option(displayText, departmentManagerId, true, true);
                                $select.append(newOption).trigger('change');
                            } else {
                                $select.val(departmentManagerId).trigger('change');
                            }
                            console.log('‚úÖ DepartmentManager set:', departmentManagerId);
                        }

                        // Set Managing Director
                        if (managingDirectorId) {
                            $('#managingDirectorIdHidden').val(managingDirectorId);
                            const $select = $('#managingDirectorSelect');
                            if ($select.find(`option[value="${managingDirectorId}"]`).length === 0) {
                                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô SKIP ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                                const displayText = (managingDirectorId === SKIP_APPROVER) ? SKIP_TEXT : managingDirectorId;
                                const newOption = new Option(displayText, managingDirectorId, true, true);
                                $select.append(newOption).trigger('change');
                            } else {
                                $select.val(managingDirectorId).trigger('change');
                            }
                            console.log('‚úÖ ManagingDirector set:', managingDirectorId);
                        }

                        // Set Deputy Managing Director
                        if (deputyManagingDirectorId) {
                            $('#deputyManagingDirectorIdHidden').val(deputyManagingDirectorId);
                            const $select = $('#deputyManagingDirectorSelect');
                            if ($select.find(`option[value="${deputyManagingDirectorId}"]`).length === 0) {
                                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô SKIP ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                                const displayText = (deputyManagingDirectorId === SKIP_APPROVER) ? SKIP_TEXT : deputyManagingDirectorId;
                                const newOption = new Option(displayText, deputyManagingDirectorId, true, true);
                                $select.append(newOption).trigger('change');
                            } else {
                                $select.val(deputyManagingDirectorId).trigger('change');
                            }
                            console.log('‚úÖ DeputyManagingDirector set:', deputyManagingDirectorId);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Approvers Select2 not initialized in time');
                    }
                    resolve();
                }
                attempts++;
            }, 100);
        });
    }

    // ===============================================
    // Multi-Select Email
    // ===============================================
    $(document).ready(function() {
        console.log('üîß Initializing CCEmail Select2...');

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ element
        if ($('#ccEmailSelect').length === 0) {
            console.error('‚ùå #ccEmailSelect not found!');
            return;
        }

        // Initialize Select2
        $('#ccEmailSelect').select2({
            theme: 'bootstrap-5',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•...',
            allowClear: true,
            multiple: true,
            width: '100%',
            ajax: {
                url: '/api/employees/emails/search',
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    console.log('üîç Searching:', params.term);
                    return { q: params.term || '' };
                },
                processResults: function (data) {
                    console.log('üìß Found:', data.length, 'emails');
                    return {
                        results: data.map(function(item) {
                            return {
                                id: item.email,
                                text: item.email + ' (' + item.name + ')'
                            };
                        })
                    };
                },
                cache: true
            },
            minimumInputLength: 0
        });

        // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å - ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô string ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ;
        $('#ccEmailSelect').on('change', function() {
            const emails = $(this).val() || [];
            const container = $('#ccEmailHiddenInputs');
            container.empty();

            if (emails.length > 0) {
                // ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô string ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ;
                const emailString = emails.join(';');
                container.append('<input type="hidden" name="CCEmail" value="' + emailString + '" />');
                console.log('‚úÖ CCEmail:', emailString);
                console.log('‚úÖ Count:', emails.length, 'emails');
            } else {
                console.log('‚ö†Ô∏è No emails selected');
            }
        });

        console.log('‚úÖ CCEmail Select2 initialized');
    });

    // ====================================================================
    // Approvers Select2 Initialization (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô CCEmail ‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 1 ‡∏Ñ‡∏ô)
    // ====================================================================
    $(document).ready(function() {
        console.log('üîß Initializing Approvers Select2...');

        // 1Ô∏è‚É£ Section Manager Select2
        $('#sectionManagerSelect').select2({
            theme: 'bootstrap-5',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Section Manager...',
            allowClear: true,
            multiple: false, // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 1 ‡∏Ñ‡∏ô
            width: '100%',
            ajax: {
                url: '/api/employees/approvers/section-manager',
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    const department = $('#departmentSelect').val();
                    const position = $('#positionSelect').val();
                    console.log('üîç Searching Section Manager:', params.term);
                    return {
                        q: params.term || '',
                        department: department || '',
                        position: position || ''
                    };
                },
                processResults: function (data) {
                    console.log('üìã Section Managers found:', data.length);

                    // Add SKIP option as first choice
                    var results = [{
                        id: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        text: '‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                    }];

                    // Add employee results
                    results = results.concat(data.map(function(item) {
                        return {
                            id: item.email,
                            text: item.email + ' (' + item.name + ' - ' + item.level + ')'
                        };
                    }));

                    return { results: results };
                },
                cache: false
            },
            minimumInputLevel: 0
        });

        $('#sectionManagerSelect').on('change', function() {
            const selectedValue = $(this).val();
            $('#sectionManagerIdHidden').val(selectedValue || '');
            console.log('‚úÖ Section Manager selected:', selectedValue);
        });

        // 2Ô∏è‚É£ Department Manager Select2 - ‚úÖ ‡πÅ‡∏Å‡πâ URL
        $('#departmentManagerSelect').select2({
            theme: 'bootstrap-5',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Department Manager...',
            allowClear: true,
            multiple: false, // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 1 ‡∏Ñ‡∏ô
            width: '100%',
            ajax: {
                url: '/api/employees/approvers/dept-manager', // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å department-manager
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    const department = $('#departmentSelect').val();
                    const position = $('#positionSelect').val();
                    console.log('üîç Searching Department Manager:', params.term);
                    return {
                        q: params.term || '',
                        department: department || '',
                        position: position || ''
                    };
                },
                processResults: function (data) {
                    console.log('üìã Department Managers found:', data.length);

                    // Add SKIP option as first choice
                    var results = [{
                        id: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        text: '‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                    }];

                    // Add employee results
                    results = results.concat(data.map(function(item) {
                        return {
                            id: item.email,
                            text: item.email + ' (' + item.name + ' - ' + item.level + ')'
                        };
                    }));

                    return { results: results };
                },
                cache: false
            },
            minimumInputLength: 0
        });

        $('#departmentManagerSelect').on('change', function() {
            const selectedValue = $(this).val();
            $('#departmentManagerIdHidden').val(selectedValue || '');
            console.log('‚úÖ Department Manager selected:', selectedValue);
        });

        // 3Ô∏è‚É£ Managing Director Select2 - ‚úÖ ‡πÅ‡∏Å‡πâ URL
        $('#managingDirectorSelect').select2({
            theme: 'bootstrap-5',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Managing Director...',
            allowClear: true,
            multiple: false, // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 1 ‡∏Ñ‡∏ô
            width: '100%',
            ajax: {
                url: '/api/employees/approvers/director', // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å managing-director
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    console.log('üîç Searching Managing Director:', params.term);
                    return {
                        q: params.term || ''
                    };
                },
                processResults: function (data) {
                    console.log('üìã Managing Directors found:', data.length);

                    // Add SKIP option as first choice
                    var results = [{
                        id: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        text: '‚è≠Ô∏è ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                    }];

                    // Add employee results
                    results = results.concat(data.map(function(item) {
                        return {
                            id: item.email,
                            text: item.email + ' (' + item.name + ' - ' + item.level + ')'
                        };
                    }));

                    return { results: results };
                },
                cache: false
            },
            minimumInputLength: 0
        });

        $('#managingDirectorSelect').on('change', function() {
            const selectedValue = $(this).val();
            $('#managingDirectorIdHidden').val(selectedValue || '');
            console.log('‚úÖ Managing Director selected:', selectedValue);
        });

        console.log('‚úÖ Approvers Select2 initialized');
    });


    // ‚úÖ Format ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Dropdown
    function formatEmailOption(option) {
        if (!option.id) {
            return option.text;
        }

        var $option = $(
            '<div>' +
                '<strong>' + option.text + '</strong>' +
                '<br><small class="text-muted">' +
                    (option.name || '') +
                    (option.department ? ' (' + option.department + ')' : '') +
                '</small>' +
            '</div>'
        );

        return $option;
    }

    // ‚úÖ Format ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•)
    function formatEmailSelection(option) {
        return option.text || option.id;
    }


    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Department
    async function loadDepartments() {
        try {
            const response = await fetch('/api/employees/departments');
            if (!response.ok) {
                throw new Error('Failed to load departments');
            }

            const departments = await response.json();
            const departmentSelect = document.getElementById('departmentSelect');

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå options ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ option ‡πÅ‡∏£‡∏Å)
            departmentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢ --</option>';

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° options ‡∏à‡∏≤‡∏Å API
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });

            console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î Departments ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', departments.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

        } catch (error) {
            console.error('‚ùå Error loading departments:', error);
            alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }
    }

    // ‚úÖ Global flag: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô reset approvers ‡∏ï‡∏≠‡∏ô pre-populate ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let isLoadingExistingData = false;

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Bind Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Department ‡πÅ‡∏•‡∏∞ Position
    function bindDepartmentPositionListeners() {
        console.log('üîß Binding Department and Position event listeners...');

        // Event: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Department ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î Position ‡πÅ‡∏•‡∏∞ reset ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        document.getElementById('departmentSelect').addEventListener('change', async function() {
            const department = this.value;
            const positionSelect = document.getElementById('positionSelect');

            // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏° reset approvers ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á pre-populate ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!isLoadingExistingData) {
                $('#sectionManagerSelect').val(null).trigger('change');
                $('#departmentManagerSelect').val(null).trigger('change');
                $('#sectionManagerIdHidden').val('');
                $('#departmentManagerIdHidden').val('');
                console.log('üîÑ Reset approvers (Department changed)');
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ disable Position dropdown
            if (!department) {
                positionSelect.disabled = true;
                positionSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô --</option>';
                return;
            }

            try {
                // ‡πÅ‡∏™‡∏î‡∏á Loading
                positionSelect.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
                positionSelect.disabled = true;

                // ‡πÇ‡∏´‡∏•‡∏î Positions ‡∏ï‡∏≤‡∏° Department ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const response = await fetch(`/api/employees/positions?department=${encodeURIComponent(department)}`);

                if (!response.ok) {
                    throw new Error('Failed to load positions');
                }

                const positions = await response.json();

                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° options ‡πÉ‡∏´‡∏°‡πà
                positionSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';

                if (positions.length === 0) {
                    positionSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ --</option>';
                    positionSelect.disabled = true;
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏ô‡∏ù‡πà‡∏≤‡∏¢:', department);
                    return;
                }

                positions.forEach(pos => {
                    const option = document.createElement('option');
                    option.value = pos;
                    option.textContent = pos;
                    positionSelect.appendChild(option);
                });

                // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô dropdown (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
                if (canEdit) {
                    positionSelect.disabled = false;
                    console.log('‚úÖ Position dropdown enabled (Edit mode)');
                } else {
                    positionSelect.disabled = true;
                    console.log('üîí Position dropdown kept disabled (Read-only/Approve mode)');
                }

                console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î Positions ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', positions.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

            } catch (error) {
                console.error('‚ùå Error loading positions:', error);
                positionSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
                positionSelect.disabled = true;
                alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        });

        // Event: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Position ‡πÉ‡∏´‡πâ reset ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        document.getElementById('positionSelect').addEventListener('change', function() {
            // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏° reset approvers ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á pre-populate ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!isLoadingExistingData) {
                $('#sectionManagerSelect').val(null).trigger('change');
                $('#departmentManagerSelect').val(null).trigger('change');
                $('#sectionManagerIdHidden').val('');
                $('#departmentManagerIdHidden').val('');
                console.log('üîÑ Reset approvers (Position changed)');
            }
        });

        console.log('‚úÖ Event listeners bound successfully');
    }

    // ====================================================================
    // Step 2: Form Submit Handler (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥)
    // ====================================================================
    (function() {
        'use strict';

        console.log('üîß Setting up form submit handler...');

        const form = document.querySelector('form[method="post"]');

        if (!form) {
            console.error('‚ùå Form not found!');
            return;
        }

        // ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit ‡∏ã‡πâ‡∏≥
        let isSubmitting = false;

        console.log('‚úÖ Form found');

        // ‚úÖ ‡πÉ‡∏ä‡πâ addEventListener ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
        form.addEventListener('submit', async function(e) {
            // ‚≠ê ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô default behavior ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á submit ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (isSubmitting) {
                console.warn('‚ö†Ô∏è Already submitting, ignoring duplicate submit');
                return false;
            }

            isSubmitting = true;
            console.log('üîµ Form submit triggered!');

            try {
                // ====================================================================
                // Validation
                // ====================================================================

                const company = document.querySelector('input[name="Company"]:checked');
                if (!company) {
                    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
                    isSubmitting = false;
                    return false;
                }

                const trainingType = document.querySelector('input[name="TrainingType"]:checked');
                if (!trainingType) {
                    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°');
                    isSubmitting = false;
                    return false;
                }

                const startDate = document.querySelector('input[name="StartDate"]');
                const endDate = document.querySelector('input[name="EndDate"]');

                if (!startDate || !startDate.value) {
                    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏£‡∏°');
                    isSubmitting = false;
                    return false;
                }

                if (!endDate || !endDate.value) {
                    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°');
                    isSubmitting = false;
                    return false;
                }

                // ====================================================================
                // Validation ‡∏ï‡∏≤‡∏° TrainingType
                // ====================================================================

                const trainingTypeValue = trainingType.value;

                if (trainingTypeValue === 'Public') {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public
                    const costPerPerson = document.getElementById('CostPerPerson');
                    const trainingHours = document.getElementById('TrainingHours');

                    if (!costPerPerson || !costPerPerson.value || parseFloat(costPerPerson.value) <= 0) {
                        alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public Training');
                        isSubmitting = false;
                        costPerPerson?.focus();
                        return false;
                    }

                    if (!trainingHours || !trainingHours.value || parseFloat(trainingHours.value) <= 0) {
                        alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public Training');
                        isSubmitting = false;
                        trainingHours?.focus();
                        return false;
                    }

                    console.log('‚úÖ Public Training validation passed');

                } else if (trainingTypeValue === 'In House') {
                    console.log('‚úÖ In House Training No required fields validation');
                }

                // ====================================================================
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                // ====================================================================

                console.log('üë• Getting employees data...');
                const employeesData = employeeManager.getEmployeesData();
                console.log('üë• Employees count:', employeesData.length);

                if (employeesData.length === 0) {
                    const confirmSubmit = confirm('‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
                    if (!confirmSubmit) {
                        console.log('‚ùå User cancelled');
                        isSubmitting = false;
                        return false;
                    }
                }

                // ====================================================================
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á FormData
                // ====================================================================

                const formData = new FormData(form);

                // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö multiple files)
                formData.delete('AttachedFiles');
                const fileInput = document.getElementById('AttachedFiles');
                if (fileInput && fileInput.files.length > 0) {
                    console.log(`üìé Attaching ${fileInput.files.length} file(s)`);
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('AttachedFiles', fileInput.files[i]);
                        console.log(`  üìÑ File ${i + 1}: ${fileInput.files[i].name}`);
                    }
                }

                formData.append('EmployeesJson', JSON.stringify(employeesData));
                formData.append('docNo', '@Model.DocNo');

                // ====================================================================
                // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ParticipantCount ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public Training
                // ====================================================================
                const participantCountField = document.getElementById('ParticipantCount');

                console.log('üîç DEBUG: ParticipantCount Auto-Set Logic');
                console.log('   TrainingType:', trainingTypeValue);
                console.log('   Employees Count:', employeesData.length);
                console.log('   ParticipantCount (before):', participantCountField?.value);

                if (trainingTypeValue === 'Public') {
                    // ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public: ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á Employee
                    const participantCount = employeesData.length > 0 ? employeesData.length : 0;

                    // ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï field ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                    if (participantCountField) {
                        participantCountField.value = participantCount.toString();
                        console.log(`‚úÖ Public Training: Set ParticipantCount = ${participantCount} (from employee count)`);
                    }
                } else {
                    // ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö In House: ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà user ‡∏Å‡∏£‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£)
                    console.log(`‚ÑπÔ∏è In House Training: ParticipantCount = ${participantCountField?.value} (from manual input)`);
                }

                console.log('   ParticipantCount (after):', participantCountField?.value);

                console.log('üì¶ FormData prepared');
                console.log('üìÑ EmployeesJson:', employeesData);

                // ====================================================================
                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend
                // ====================================================================

                const submitBtn = form.querySelector('button[type="submit"]');
                const originalHTML = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

                console.log('üöÄ Sending to /TrainingRequest/UpdateTrainingRequest');

                const response = await fetch('/TrainingRequest/UpdateTrainingRequest', {
                    method: 'POST',
                    body: formData
                });

                console.log('üì• Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Response error:', errorText);
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                console.log('üì• Response:', result);

                if (result.success) {
                    console.log('‚úÖ Save successful!');
                    alert(`‚úÖ ${result.message}\n\nüìÑ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${result.docNo}`);

                    // Redirect to MonthlyRequests
                    setTimeout(() => {
                        window.location.href = '/Home/MonthlyRequests';
                    }, 500);

                } else {
                    alert('‚ùå ' + result.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                    isSubmitting = false;
                }

            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n\n' + error.message);

                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'üíæ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                }
                isSubmitting = false;
            }

            return false;

        }, { once: false, capture: true }); // ‚≠ê ‡πÉ‡∏ä‡πâ capture phase

        console.log('‚úÖ Form submit handler installed!');

        // ====================================================================
        // File Attachment Management
        // ====================================================================

        // Load attachments when page loads
        async function loadAttachments() {
            const docNo = '@Model.DocNo';
            console.log('üìé Loading attachments for DocNo:', docNo);

            try {
                const response = await fetch(`/TrainingRequest/GetAttachments?docNo=${encodeURIComponent(docNo)}`);
                const result = await response.json();

                if (result.success && result.attachments && result.attachments.length > 0) {
                    console.log('‚úÖ Attachments loaded:', result.attachments.length);
                    displayAttachments(result.attachments);
                    document.getElementById('attachmentsSection').style.display = 'block';
                } else {
                    console.log('‚ÑπÔ∏è No attachments found');
                    document.getElementById('attachmentsSection').style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Error loading attachments:', error);
            }
        }

        function displayAttachments(attachments) {
            const listContainer = document.getElementById('attachmentsList');
            listContainer.innerHTML = '';

            attachments.forEach((attachment, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.style.borderRadius = '8px';
                item.style.marginBottom = '8px';

                // File icon based on extension
                const ext = attachment.originalName.split('.').pop().toLowerCase();
                let icon = 'fa-file';
                let iconColor = '#6c757d';

                if (['pdf'].includes(ext)) {
                    icon = 'fa-file-pdf';
                    iconColor = '#dc3545';
                } else if (['doc', 'docx'].includes(ext)) {
                    icon = 'fa-file-word';
                    iconColor = '#2b579a';
                } else if (['xls', 'xlsx'].includes(ext)) {
                    icon = 'fa-file-excel';
                    iconColor = '#217346';
                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                    icon = 'fa-file-image';
                    iconColor = '#0dcaf0';
                } else if (['zip', 'rar'].includes(ext)) {
                    icon = 'fa-file-zipper';
                    iconColor = '#ffc107';
                }

                item.innerHTML = `
                    <div class="d-flex align-items-center flex-grow-1">
                        <i class="fas ${icon} fa-2x me-3" style="color: ${iconColor};"></i>
                        <div>
                            <div class="fw-bold">${attachment.originalName}</div>
                            <small class="text-muted">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(attachment.uploadDate)}</small>
                        </div>
                    </div>
                    <div class="btn-group">
                        <a href="/TrainingRequest/DownloadAttachment?attachmentId=${attachment.id}"
                           class="btn btn-sm btn-outline-primary"
                           title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î">
                            <i class="fas fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                        </a>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                onclick="deleteAttachment(${attachment.id}, '${attachment.originalName}')"
                                title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå">
                            <i class="fas fa-trash"></i> ‡∏•‡∏ö
                        </button>
                    </div>
                `;

                listContainer.appendChild(item);
            });
        }

        async function deleteAttachment(attachmentId, fileName) {
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå "${fileName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                return;
            }

            try {
                const response = await fetch('/TrainingRequest/DeleteAttachment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ attachmentId: attachmentId })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ File deleted successfully');
                    alert('‚úÖ ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    // Reload attachments list
                    await loadAttachments();
                } else {
                    alert('‚ùå ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Error deleting attachment:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå');
            }
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return date.toLocaleDateString('th-TH', options);
            } catch (e) {
                return dateString;
            }
        }

        // Make deleteAttachment available globally
        window.deleteAttachment = deleteAttachment;

        // Load attachments on page load
        loadAttachments();
    })();
</script>